<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="SWP201 - H·ªá th·ªëng ƒë·ªïi pin xe m√°y ƒëi·ªán th√¥ng minh - Qu·∫£n l√Ω ng∆∞·ªùi d√πng, tr·∫°m, thanh to√°n v·ªõi b·∫£n ƒë·ªì t∆∞∆°ng t√°c" />
  <title>SWP201 - H·ªá Th·ªëng ƒê·ªïi Pin Xe M√°y ƒêi·ªán</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    :root{
      --bg:#0b1020;
      --card:#121831;
      --muted:#9aa4c7;
      --text:#e8ecff;
      --brand:#4f8cff;
      --brand-2:#6ae3ff;
      --ok:#19c37d;
      --warn:#ffb020;
      --danger:#ff5573;
      --ring:rgba(111,153,255,.45);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius-sm:10px;
      --radius-lg:20px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}
    .container{max-width:1120px;margin:0 auto;padding:0 20px}
    
    /* Header */
    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(1.2) blur(10px);background:rgba(10,14,32,.55);border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo svg{width:18px;height:18px;fill:white}
    .nav-links{display:flex;gap:18px}
    .nav-links a:hover{color:var(--brand-2)}
    .auth-buttons{display:flex;gap:10px}
    
    /* Buttons */
    .btn{padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);color:var(--text);cursor:pointer;font-size:14px;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#061023;font-weight:700}
    .btn-success{background:linear-gradient(135deg,var(--ok),#9effce);border:none;color:#061023;font-weight:700}
    .btn-warning{background:linear-gradient(135deg,var(--warn),#ffd0a0);border:none;color:#061023;font-weight:700}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#ff8fa3);border:none;color:white;font-weight:700}
    .btn:hover{border-color:rgba(255,255,255,.2);transform:translateY(-1px)}
    .btn-primary:hover{box-shadow:0 8px 25px rgba(79,140,255,.3)}
    
    /* Hero */
    .hero{padding:56px 0 18px;text-align:center;background:radial-gradient(1200px 500px at 50% -50%,rgba(111,153,255,.25),transparent 60%),radial-gradient(600px 280px at 0% 0%,rgba(106,227,255,.16),transparent 60%),radial-gradient(600px 280px at 100% 0%,rgba(106,227,255,.12),transparent 60%)}
    .eyebrow{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:13px;background:rgba(255,255,255,.03);margin-bottom:18px}
    .title{font-size:44px;line-height:1.1;margin:18px 0 14px}
    .title strong{background:linear-gradient(135deg,#fff,#9bc2ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{color:var(--muted);max-width:780px;margin:0 auto 22px;font-size:16px}
    .hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:6px}
    
    /* Sections */
    section{padding:36px 0}
    .grid{display:grid;gap:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);transition:all .3s}
    .card:hover{border-color:rgba(255,255,255,.2);transform:translateY(-2px)}
    .card.featured{border-color:var(--brand);box-shadow:0 10px 40px rgba(79,140,255,.2)}
    .icon{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;margin-bottom:10px;background:linear-gradient(135deg,rgba(79,140,255,.25),rgba(106,227,255,.18));border:1px solid rgba(255,255,255,.12);font-size:18px}
    
    h1,h2,h3,h4,h5,h6{margin:0}
    h2{font-size:26px;margin:0 0 12px}
    h3{margin:8px 0 6px}
    h4{margin:12px 0 8px;color:var(--brand-2)}
    .muted{color:var(--muted);font-size:14px}
    
    /* Features */
    #features .grid{grid-template-columns:repeat(3,1fr)}
    
    /* Pricing */
    .pricing{display:grid;gap:18px;grid-template-columns:repeat(3,1fr)}
    .price{font-size:28px;font-weight:800;margin:8px 0}
    .chip{display:inline-block;font-size:12px;color:#061023;background:linear-gradient(135deg,var(--ok),#9effce);padding:6px 10px;border-radius:999px;margin-left:8px}
    ul.clean{list-style:none;padding:0;margin:12px 0 0}
    ul.clean li{display:flex;gap:8px;align-items:flex-start;margin:8px 0;color:var(--muted)}
    .tick{color:var(--ok);font-weight:800}
    
    /* Map */
    .map-container{margin:20px 0;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .station-info{margin-top:20px}
    .stations{grid-template-columns:repeat(3,1fr)}
    
    /* Contact */
    .contact-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    
    /* Footer */
    footer{padding:22px 0;color:var(--muted);border-top:1px solid rgba(255,255,255,.08);margin-top:28px}
    .footer-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:20px}
    .footer-grid a{display:block;margin:4px 0;color:var(--muted);transition:color .2s}
    .footer-grid a:hover{color:var(--brand-2)}
    .footer-bottom{text-align:center;padding-top:20px;border-top:1px solid rgba(255,255,255,.06);font-size:14px}
    
    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
    .modal-content{background:var(--card);margin:5% auto;padding:0;border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);width:90%;max-width:500px;box-shadow:var(--shadow);animation:modalSlideIn .3s ease}
    @keyframes modalSlideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.1)}
    .modal-header h3{margin:0}
    .close-btn{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .2s}
    .close-btn:hover{background:rgba(255,255,255,.1);color:var(--text)}
    
    /* Forms */
    form{padding:24px}
    .form-group{margin-bottom:16px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-group label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-size:14px;outline:none;transition:all .2s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
    .form-actions{display:flex;gap:12px;margin-top:20px}
    .form-actions .btn{flex:1}
    
    /* Demo Accounts */
    .demo-accounts{padding:0 24px 24px;border-top:1px solid rgba(255,255,255,.1);margin-top:20px;padding-top:20px}
    .demo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
    .demo-btn{padding:8px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);cursor:pointer;font-size:12px;text-align:center;transition:all .2s}
    .demo-btn:hover{background:rgba(255,255,255,.1);color:var(--text);border-color:rgba(255,255,255,.2)}
    
    /* Toast */
    .toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:var(--shadow);display:none;z-index:1001;max-width:300px;animation:toastSlideIn .3s ease}
    @keyframes toastSlideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-color:var(--ok)}
    .toast.error{border-color:var(--danger)}
    .toast.warning{border-color:var(--warn)}
    
    /* Dashboard */
    .dashboard{display:none;min-height:100vh}
    .dashboard.active{display:block}
    .dashboard-header{background:var(--card);border-bottom:1px solid rgba(255,255,255,.1);padding:20px 0}
    .dashboard-nav{display:flex;justify-content:space-between;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:white;font-weight:700}
    .logout-btn{padding:8px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);cursor:pointer;font-size:14px;transition:all .2s}
    .logout-btn:hover{background:rgba(255,93,115,.1);border-color:var(--danger);color:var(--danger)}
    .dashboard-content{padding:24px 0}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:24px}

    /* Payment Modal Styles */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .payment-methods {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .payment-method {
      flex: 1;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .payment-method:hover {
      border-color: var(--primary);
    }

    .payment-method.active {
      border-color: var(--primary);
      background: var(--primary-bg);
    }

    .payment-method input[type="radio"] {
      display: none;
    }

    .method-info {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .method-icon {
      font-size: 20px;
    }

    .contract-document {
      background: white;
      color: #333;
      padding: 40px;
      font-family: 'Times New Roman', serif;
      line-height: 1.6;
    }

    .contract-header h2 {
      color: #000;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .contract-section {
      margin-bottom: 30px;
    }

    .contract-section h3 {
      color: #000;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 15px;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
    }

    .contract-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .contract-table td {
      padding: 8px 12px;
      border: 1px solid #ddd;
    }

    .contract-table td:first-child {
      background: #f5f5f5;
      width: 30%;
    }

    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 30px;
    }

    .signature-block {
      text-align: center;
    }

    .digital-signature {
      margin-top: 20px;
    }

    .signature-stamp {
      border: 3px solid #000;
      padding: 20px;
      background: #f0f8ff;
      font-weight: bold;
      text-transform: uppercase;
      display: inline-block;
      transform: rotate(-5deg);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    .contract-footer {
      margin-top: 40px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    #credit-card-form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .stat-card{background:linear-gradient(135deg,var(--card) 0%,rgba(18,24,49,.8) 100%);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:20px;text-align:center}
    .stat-value{font-size:32px;font-weight:800;margin-bottom:8px}
    .stat-label{color:var(--muted);font-size:14px}
    
    /* Tables */
    .data-table{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);overflow:hidden}
    .table-header{background:rgba(255,255,255,.05);padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;align-items:center}
    .table-filters{display:flex;gap:12px;align-items:center}
    .filter-select,.filter-input{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
    .status{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .status.success{background:rgba(25,195,125,.2);color:var(--ok)}
    .status.warning{background:rgba(255,176,32,.2);color:var(--warn)}
    .status.danger{background:rgba(255,85,115,.2);color:var(--danger)}
    .action-btn{padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:var(--text);cursor:pointer;font-size:12px;margin-right:4px}
    .action-btn:hover{background:rgba(255,255,255,.1)}
    
    /* User Dashboard Tabs */
    .user-nav{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.1);padding:0}
    .nav-tabs{display:flex;gap:0;overflow-x:auto}
    .nav-tab{padding:16px 24px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;border-bottom:3px solid transparent;white-space:nowrap}
    .nav-tab:hover{color:var(--text);background:rgba(255,255,255,.05)}
    .nav-tab.active{color:var(--brand);border-bottom-color:var(--brand);background:rgba(79,140,255,.1)}
    
    /* Tab Content */
    .tab-content{display:none;padding-top:24px}
    .tab-content.active{display:block}
    
    /* Station Posts Selection */
    .post-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px}
    .post-item{padding:12px;border:1px solid rgba(255,255,255,.1);border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02)}
    .post-item:hover{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .post-item.selected{border-color:var(--brand);background:var(--brand);color:#061023}
    .post-item.occupied{border-color:var(--danger);background:rgba(255,85,115,.1);color:var(--danger);cursor:not-allowed}

    /* Slot Grid */
    .slot-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .slot-item{padding:6px 2px;border:1px solid rgba(255,255,255,.1);border-radius:6px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02);font-size:11px}
    .slot-item:hover{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .slot-item.selected{border-color:var(--brand);background:var(--brand);color:#061023}
    .slot-item.has-battery{border-color:var(--ok);background:rgba(25,195,125,.1);color:var(--ok)}
    .slot-item.empty{border-color:var(--muted);background:rgba(255,255,255,.05);color:var(--muted)}
    .slot-item.charging{border-color:var(--warn);background:rgba(255,176,32,.1);color:var(--warn)}
    .slot-item.maintenance{border-color:var(--danger);background:rgba(255,85,115,.1);color:var(--danger);cursor:not-allowed}
    
    /* Station List Items */
    .station-item{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer;transition:all .2s}
    .station-item:hover{background:rgba(255,255,255,.05)}
    .station-item:last-child{border-bottom:none}
    
    /* Payment Method Icons */
    .payment-method{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;transition:all .2s}
    .payment-method:hover{background:rgba(255,255,255,.05)}
    
    /* Top-up Amount Display */
    .amount-display{font-size:18px;font-weight:600;color:var(--brand);text-align:center;margin:8px 0}
    
    /* Map Container in User Dashboard */
    #user-map{border:1px solid rgba(255,255,255,.1)}
    
    /* Battery Health Management Styles */
    .battery-health-dashboard{max-width:1200px;margin:0 auto}
    .vehicle-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
    .vehicle-card{background:var(--card);border:2px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:20px;transition:all .3s ease;cursor:pointer}
    .vehicle-card:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow)}
    .vehicle-card.selected{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .vehicle-info h4{color:var(--text);margin-bottom:8px}
    .vehicle-info p{color:var(--muted);margin-bottom:15px}
    .battery-preview{margin:15px 0}
    .charge-level{margin-bottom:10px}
    .charge-percent{font-size:1.2rem;font-weight:600;color:var(--text)}
    .charge-bar{width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px}
    .charge-fill{height:100%;background:linear-gradient(90deg,#4CAF50 0%,#8BC34A 50%,#CDDC39 100%);transition:width .3s ease}
    .health-indicator{margin-top:10px}
    .health-percent{font-weight:600;padding:4px 8px;border-radius:6px;font-size:.9rem}
    .health-percent.excellent{background:#4CAF50;color:white}
    .health-percent.good{background:#8BC34A;color:white}
    .health-percent.fair{background:#FF9800;color:white}
    .health-percent.poor{background:#F44336;color:white}
    .detailed-battery-view{margin-top:30px}
    .vehicle-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,.1)}
    .last-updated{color:var(--muted);font-size:.9rem}
    .battery-metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;margin-bottom:30px}
    .metric-card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:25px}
    .metric-card h4{color:var(--text);margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .large-charge-display{text-align:center}
    .charge-circle{position:relative;width:150px;height:150px;margin:0 auto 20px}
    .charge-circle svg{width:100%;height:100%;transform:rotate(-90deg)}
    .charge-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .charge-number{font-size:2.5rem;font-weight:700;color:var(--text)}
    .charge-unit{font-size:1.2rem;color:var(--muted)}
    .range-estimate{color:var(--muted);font-size:.95rem}
    .health-gauge{margin-bottom:20px}
    .health-bar{width:100%;height:20px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;margin-bottom:10px}
    .health-fill{height:100%;border-radius:10px;transition:width .3s ease}
    .health-fill.excellent{background:linear-gradient(90deg,#4CAF50,#66BB6A)}
    .health-fill.good{background:linear-gradient(90deg,#8BC34A,#9CCC65)}
    .health-fill.fair{background:linear-gradient(90deg,#FF9800,#FFB74D)}
    .health-fill.poor{background:linear-gradient(90deg,#F44336,#EF5350)}
    .health-value{text-align:center}
    .health-number{font-size:1.8rem;font-weight:600;color:var(--text)}
    .health-label{display:block;color:var(--muted);font-size:.9rem;margin-top:5px}
    .health-details{border-top:1px solid rgba(255,255,255,.1);padding-top:15px}
    .detail-item{display:flex;justify-content:space-between;margin-bottom:8px}
    .detail-item span{color:var(--muted)}
    .detail-item strong{color:var(--text)}
    .info-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(148,163,184,.1)}
    .info-item:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-size:.9rem}
    .info-value{color:var(--text);font-weight:500}
    .chart-section{margin:30px 0;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:25px}
    .chart-section h4{margin-bottom:20px}
    .chart-container{background:rgba(255,255,255,.02);border-radius:8px;padding:20px}
    .simple-chart{display:flex;align-items:stretch;height:220px}
    .chart-y-axis{display:flex;flex-direction:column;justify-content:space-between;padding-right:10px;font-size:.8rem;color:var(--muted);width:40px}
    .chart-area{flex:1;background:linear-gradient(to bottom,rgba(76,175,80,.1) 0%,rgba(76,175,80,.05) 100%);border-radius:4px;margin:0 10px}
    .chart-svg{width:100%;height:100%}
    .chart-x-axis{display:flex;justify-content:space-between;margin-top:10px;font-size:.8rem;color:var(--muted)}
    .recommendations-section{margin:30px 0}
    .recommendations-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px}
    .recommendation-card{display:flex;align-items:center;gap:15px;padding:15px;border-radius:8px;border-left:4px solid}
    .recommendation-card.success{background:rgba(76,175,80,.1);border-left-color:#4CAF50}
    .recommendation-card.warning{background:rgba(255,152,0,.1);border-left-color:#FF9800}
    .recommendation-card.info{background:rgba(33,150,243,.1);border-left-color:#2196F3}
    .rec-icon{font-size:1.5rem;flex-shrink:0}
    .rec-content h5{color:var(--text);margin-bottom:5px;font-size:.95rem}
    .rec-content p{color:var(--muted);font-size:.85rem;margin:0;line-height:1.4}
    .export-section{text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)}
    .loading-message{text-align:center;padding:60px 20px;color:var(--muted)}
    .loading-spinner{font-size:2rem;margin-bottom:15px;animation:spin 2s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Plan Selection Modal */
    .plan-selection-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
    .plan-selection-content{background:var(--card);border-radius:var(--radius);padding:30px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto}
    .plan-selection-header{text-align:center;margin-bottom:30px}
    .plan-selection-header h2{color:var(--text);margin-bottom:10px}
    .plan-selection-header p{color:var(--muted);margin-bottom:0}
    .plans-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px}
    .plan-option{background:rgba(255,255,255,.03);border:3px solid rgba(255,255,255,.1);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all .3s ease;position:relative}
    .plan-option:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.3)}
    .plan-option.selected{border-color:var(--brand);box-shadow:0 0 20px rgba(79,140,255,.3)}
    .plan-header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-hover) 100%);color:white;padding:20px;text-align:center}
    .plan-icon{font-size:2.5rem;display:block;margin-bottom:10px}
    .plan-header h3{margin:0 0 8px 0;font-size:1.4rem;font-weight:600}
    .plan-price{font-size:1.1rem;font-weight:500;opacity:.9}
    .plan-features{padding:20px}
    .plan-features h4{color:var(--text);margin:0 0 12px 0;font-size:1rem;font-weight:600}
    .plan-features ul{list-style:none;padding:0;margin:0 0 20px 0}
    .plan-features li{color:var(--muted);padding:4px 0;font-size:.9rem}
    .plan-vehicles{display:flex;flex-direction:column;gap:8px}
    .vehicle-preview{display:flex;align-items:center;gap:10px;padding:8px;background:rgba(255,255,255,.05);border-radius:6px}
    .vehicle-preview span{font-size:1.5rem}
    .vehicle-preview strong{color:var(--text);font-size:.9rem}
    .vehicle-preview small{color:var(--muted);font-size:.8rem}
    .selected-plan-info{margin-top:15px}
    .plan-badge{display:inline-block;padding:8px 16px;border-radius:20px;color:white;font-weight:500;font-size:.9rem}
    
    /* Vehicle Selection Modal */
    .vehicle-selection-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
    .vehicle-selection-content{background:var(--card);border-radius:var(--radius);padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
    .vehicle-selection-header{text-align:center;margin-bottom:30px}
    .vehicle-selection-header h2{color:var(--text);margin-bottom:10px}
    .vehicle-selection-header p{color:var(--muted);margin-bottom:0}
    .vehicles-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}
    .vehicle-option{background:rgba(255,255,255,.03);border:2px solid rgba(255,255,255,.1);border-radius:var(--radius-sm);padding:20px;cursor:pointer;transition:all .3s ease;text-align:center}
    .vehicle-option:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow)}
    .vehicle-option.selected{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .vehicle-icon{font-size:3rem;margin-bottom:15px;display:block}
    .vehicle-name{font-size:1.2rem;font-weight:600;color:var(--text);margin-bottom:8px}
    .vehicle-details{color:var(--muted);font-size:.9rem;line-height:1.4}
    .vehicle-battery{margin-top:12px;padding:8px 12px;background:rgba(76,175,80,.1);border-radius:6px;color:#4CAF50;font-weight:500}
    .modal-actions{display:flex;gap:15px;justify-content:center;margin-top:25px}
    
    /* Responsive for User Dashboard */
    @media (max-width:768px){
      .nav-tabs{flex-direction:column}
      .nav-tab{text-align:center;border-bottom:1px solid rgba(255,255,255,.1);border-left:3px solid transparent}
      .nav-tab.active{border-left-color:var(--brand);border-bottom-color:transparent}
    }
    
    /* Responsive */
    @media (max-width:1024px){
      #features .grid{grid-template-columns:repeat(2,1fr)}
      .pricing{grid-template-columns:1fr}
      .stations{grid-template-columns:repeat(2,1fr)}
      .contact-grid{grid-template-columns:1fr}
      .footer-grid{grid-template-columns:1fr;text-align:center}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:768px){
      .nav{flex-wrap:wrap;height:auto;padding:12px 0}
      .nav-links{order:3;width:100%;justify-content:center;margin-top:12px}
      .title{font-size:34px}
      #features .grid{grid-template-columns:1fr}
      .stations{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
      .demo-grid{grid-template-columns:1fr}
      .form-actions{flex-direction:column}
      .stats-grid{grid-template-columns:1fr}
      .table-filters{flex-direction:column;align-items:stretch}
      .dashboard-nav{flex-direction:column;gap:16px;text-align:center}
    }
    
    /* Payment Sub-Tabs */
    .payment-container { padding: 20px 0; }
    .payment-sub-nav {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .payment-sub-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 14px;
    }
    .payment-sub-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }
    .payment-sub-content {
      display: none;
      padding: 20px 0;
    }
    .payment-sub-content.active {
      display: block;
    }
    
    /* Payment Methods */
    .payment-method-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .payment-method {
      background: var(--card);
      border: 2px solid rgba(255,255,255,.1);
      border-radius: var(--radius-sm);
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .payment-method:hover {
      border-color: var(--brand);
    }
    .payment-method.selected {
      border-color: var(--brand);
      background: rgba(79,140,255,.1);
    }
    .method-icon {
      font-size: 24px;
    }
    .method-info h6 {
      margin: 0 0 4px 0;
      color: var(--text);
    }
    .method-info p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }
    .payment-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* Auto Pay Styles */
    .autopay-toggle {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: var(--card);
      border-radius: var(--radius);
      margin-bottom: 20px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: var(--brand);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .slider.round {
      border-radius: 34px;
    }
    .slider.round:before {
      border-radius: 50%;
    }
    .autopay-settings {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .setting-group {
      margin-bottom: 20px;
    }
    .setting-group h5 {
      margin-bottom: 10px;
      color: var(--text);
    }
    .autopay-method-selection {
      display: flex;
      gap: 15px;
    }
    .autopay-method {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: rgba(255,255,255,.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .autopay-method:hover {
      background: rgba(255,255,255,.1);
    }
    .notification-settings {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      cursor: pointer;
    }
    .autopay-record {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--card);
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .record-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .record-date {
      font-weight: 500;
      color: var(--text);
    }
    .record-amount {
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
        </div>
        SWP201
      </div>
      <nav class="nav-links">
        <a href="#features">T√≠nh nƒÉng</a>
        <a href="#pricing">B·∫£ng gi√°</a>
        <a href="#stations">Tr·∫°m</a>
        <a href="#contact">Li√™n h·ªá</a>
      </nav>
      <div class="auth-buttons">
        <button class="btn" onclick="showLogin()">ƒêƒÉng nh·∫≠p</button>
        <button class="btn btn-primary" onclick="showRegister()">ƒêƒÉng k√Ω</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <div class="eyebrow">SWP201 ‚Ä¢ ƒê·ªïi pin trong 3 ph√∫t ‚Ä¢ Thanh to√°n th√¥ng minh ‚Ä¢ Qu·∫£n l√Ω t·ª± ƒë·ªông</div>
        <h1 class="title">SWP201: H·ªá th·ªëng <strong>ƒë·ªïi pin xe ƒëi·ªán</strong> th√¥ng minh</h1>
        <p class="subtitle">N·ªÅn t·∫£ng qu·∫£n l√Ω to√†n di·ªán cho ng∆∞·ªùi d√πng, nh√¢n vi√™n v√† qu·∫£n tr·ªã vi√™n. T√≠ch h·ª£p b·∫£n ƒë·ªì, thanh to√°n v√† theo d√µi real-time.</p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="showLogin()">Truy c·∫≠p h·ªá th·ªëng</button>
          <button class="btn" onclick="scrollToId('stations')">Xem b·∫£n ƒë·ªì tr·∫°m</button>
        </div>
      </div>
    </section>

    <section id="features">
      <div class="container">
        <h2>T√≠nh nƒÉng h·ªá th·ªëng</h2>
        <div class="grid">
          <div class="card">
            <div class="icon">üë§</div>
            <h3>Dashboard ng∆∞·ªùi d√πng</h3>
            <p class="muted">Theo d√µi l·ªãch s·ª≠ ƒë·ªïi pin, thanh to√°n, t√¨m tr·∫°m g·∫ßn nh·∫•t v√† ƒë·∫∑t l·ªãch online.</p>
          </div>
          <div class="card">
            <div class="icon">üë®‚Äç </div>
            <h3>Dashboard nh√¢n vi√™n</h3>
            <p class="muted">Qu·∫£n l√Ω tr·∫°m, theo d√µi t√¨nh tr·∫°ng pin, x·ª≠ l√Ω y√™u c·∫ßu kh√°ch h√†ng.</p>
          </div>
          <div class="card">
            <div class="icon">‚öôÔ∏è</div>
            <h3>Dashboard qu·∫£n tr·ªã</h3>
            <p class="muted">Th·ªëng k√™ to√†n h·ªá th·ªëng, qu·∫£n l√Ω ng∆∞·ªùi d√πng, c·∫•u h√¨nh v√† b√°o c√°o.</p>
          </div>
          <div class="card">
            <div class="icon"> Ô∏è</div>
            <h3>B·∫£n ƒë·ªì t∆∞∆°ng t√°c</h3>
            <p class="muted">T√¨m tr·∫°m theo v·ªã tr√≠, xem t√¨nh tr·∫°ng real-time, ƒëi·ªÅu h∆∞·ªõng GPS.</p>
          </div>
          <div class="card">
            <div class="icon">üí≥</div>
            <h3>Thanh to√°n th√¥ng minh</h3>
            <p class="muted">Nhi·ªÅu ph∆∞∆°ng th·ª©c thanh to√°n, l·ªçc giao d·ªãch, xu·∫•t b√°o c√°o chi ti·∫øt.</p>
          </div>
          <div class="card">
            <div class="icon">üîã</div>
            <h3>Qu·∫£n l√Ω pin</h3>
            <p class="muted">Theo d√µi t√¨nh tr·∫°ng pin, l·ªãch b·∫£o tr√¨, t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="pricing">
      <div class="container">
        <h2>G√≥i d·ªãch v·ª•</h2>
        <div class="pricing">
          <div class="card">
            <h3>C∆° b·∫£n</h3>
            <div class="price">89.000ƒë/l∆∞·ª£t</div>
            <ul class="clean">
              <li><span class="tick">‚úì</span> ƒê·ªïi pin ti√™u chu·∫©n</li>
              <li><span class="tick">‚úì</span> App mobile</li>
              <li><span class="tick">‚úì</span> Thanh to√°n QR</li>
            </ul>
            <button class="btn btn-primary" onclick="showLogin()">ƒêƒÉng k√Ω ngay</button>
          </div>
          <div class="card featured">
            <h3>Premium <span class="chip">Ph·ªï bi·∫øn</span></h3>
            <div class="price">299.000ƒë/th√°ng</div>
            <ul class="clean">
              <li><span class="tick">‚úì</span> 8 l∆∞·ª£t/th√°ng</li>
              <li><span class="tick">‚úì</span> ∆Øu ti√™n t·∫°i tr·∫°m</li>
              <li><span class="tick">‚úì</span> H·ªó tr·ª£ 24/7</li>
              <li><span class="tick">‚úì</span> B√°o c√°o chi ti·∫øt</li>
            </ul>
            <button class="btn btn-primary" onclick="showLogin()">Ch·ªçn g√≥i</button>
          </div>
          <div class="card">
            <h3>Doanh nghi·ªáp</h3>
            <div class="price">Li√™n h·ªá</div>
            <ul class="clean">
              <li><span class="tick">‚úì</span> Kh√¥ng gi·ªõi h·∫°n</li>
              <li><span class="tick">‚úì</span> API t√≠ch h·ª£p</li>
              <li><span class="tick">‚úì</span> Dashboard qu·∫£n l√Ω</li>
              <li><span class="tick">‚úì</span> SLA 99.9%</li>
            </ul>
            <button class="btn" onclick="showContact()">T∆∞ v·∫•n</button>
          </div>
        </div>
      </div>
    </section>

    <section id="stations">
      <div class="container">
        <h2>B·∫£n ƒë·ªì tr·∫°m ƒë·ªïi pin</h2>
        <div class="map-container">
          <div id="map" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
        </div>
        <div class="station-info">
          <div class="grid stations">
            <div class="card" id="selected-station">
              <h3>Ch·ªçn tr·∫°m tr√™n b·∫£n ƒë·ªì</h3>
              <p class="muted">Click v√†o c√°c marker ƒë·ªÉ xem th√¥ng tin chi ti·∫øt tr·∫°m.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="contact">
      <div class="container">
        <h2>Li√™n h·ªá h·ªó tr·ª£</h2>
        <div class="contact-grid">
          <div class="card">
            <h3>üìû Hotline</h3>
            <p>1900 xxxx (24/7)</p>
            <p class="muted">H·ªó tr·ª£ kh·∫©n c·∫•p v√† t∆∞ v·∫•n</p>
          </div>
          <div class="card">
            <h3>‚úâÔ∏è Email</h3>
            <p>support@doipin.vn</p>
            <p class="muted">G√≥p √Ω v√† h·ªó tr·ª£ k·ªπ thu·∫≠t</p>
          </div>
          <div class="card">
            <h3>üìç VƒÉn ph√≤ng</h3>
            <p>T·∫ßng 10, T√≤a nh√† FPT</p>
            <p class="muted">TP.HCM & H√† N·ªôi</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
        <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
      </div>
      <form id="loginForm" onsubmit="return handleLogin(event)">
        <div class="form-group">
          <label for="username">T√™n ƒëƒÉng nh·∫≠p / Email</label>
          <input id="username" type="text" required placeholder="admin@example.com" />
        </div>
        <div class="form-group">
          <label for="password">M·∫≠t kh·∫©u</label>
          <input id="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="form-group">
          <label for="userRole">Vai tr√≤</label>
          <select id="userRole" required>
            <option value="">Ch·ªçn vai tr√≤</option>
            <option value="user">Ng∆∞·ªùi d√πng</option>
            <option value="staff">Nh√¢n vi√™n</option>
            <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
          <button type="button" class="btn" onclick="showRegister()">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
        </div>
      </form>
      <div class="demo-accounts">
        <h4>T√†i kho·∫£n demo:</h4>
        <div class="demo-grid">
          <button class="demo-btn" onclick="quickLogin('user', 'user@demo.com', '123456')">
            üë§ User Demo
          </button>
          <button class="demo-btn" onclick="quickLogin('staff', 'staff@demo.com', '123456')">
            üë®‚Äçüíº Staff Demo
          </button>
          <button class="demo-btn" onclick="quickLogin('admin', 'admin@demo.com', '123456')">
            ‚öôÔ∏è Admin Demo
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ƒêƒÉng k√Ω t√†i kho·∫£n</h3>
        <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
      </div>
      <form id="registerForm" onsubmit="return handleRegister(event)">
        <div class="form-row">
          <div class="form-group">
            <label for="regName">H·ªç v√† t√™n</label>
            <input id="regName" type="text" required placeholder="Nguy·ªÖn VƒÉn A" />
          </div>
          <div class="form-group">
            <label for="regPhone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input id="regPhone" type="tel" required placeholder="09xx xxx xxx" />
          </div>
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" required placeholder="example@email.com" />
        </div>
        <div class="form-group">
          <label for="regPassword">M·∫≠t kh·∫©u</label>
          <input id="regPassword" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ƒêƒÉng k√Ω</button>
          <button type="button" class="btn" onclick="showLogin()">ƒê√£ c√≥ t√†i kho·∫£n</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <h4>SWP201</h4>
          <p>H·ªá th·ªëng ƒë·ªïi pin xe ƒëi·ªán th√¥ng minh h√†ng ƒë·∫ßu Vi·ªát Nam</p>
        </div>
        <div>
          <h4>Li√™n k·∫øt</h4>
          <a href="#features">T√≠nh nƒÉng</a>
          <a href="#pricing">B·∫£ng gi√°</a>
          <a href="#stations">Tr·∫°m</a>
        </div>
        <div>
          <h4>H·ªó tr·ª£</h4>
          <a href="#contact">Li√™n h·ªá</a>
          <a href="#">H∆∞·ªõng d·∫´n</a>
          <a href="#">FAQ</a>
        </div>
      </div>
      <div class="footer-bottom">
        ¬© 2025 SWP201 ‚Ä¢ H·ªá th·ªëng qu·∫£n l√Ω th√¥ng minh
      </div>
    </div>
  </footer>

  <!-- Payment Modal -->
  <div id="payment-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üí≥ Thanh to√°n g√≥i d·ªãch v·ª•</h2>
        <span class="close" onclick="closePaymentModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="payment-step-1">
          <div class="card" style="margin-bottom: 20px;">
            <h3 id="selected-plan-info">G√≥i Premium - 299.000ƒë/th√°ng</h3>
            <p class="muted" id="plan-description">8 l∆∞·ª£t ƒë·ªïi pin/th√°ng ‚Ä¢ ∆Øu ti√™n t·∫°i tr·∫°m ‚Ä¢ H·ªó tr·ª£ 24/7</p>
          </div>
          
          <div class="form-group">
            <label>Th√¥ng tin thanh to√°n</label>
            <div class="payment-methods">
              <label class="payment-method active">
                <input type="radio" name="payment-method" value="credit-card" checked>
                <div class="method-info">
                  <span class="method-icon">üí≥</span>
                  <span>Th·∫ª t√≠n d·ª•ng/ghi n·ª£</span>
                </div>
              </label>
              <label class="payment-method">
                <input type="radio" name="payment-method" value="bank-transfer">
                <div class="method-info">
                  <span class="method-icon">üè¶</span>
                  <span>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
              </label>
            </div>
          </div>

          <div id="credit-card-form">
            <div class="form-group">
              <label>S·ªë th·∫ª *</label>
              <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label>Th√°ng/NƒÉm *</label>
                <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <label>CVV *</label>
                <input type="text" id="card-cvv" placeholder="123" maxlength="3">
              </div>
            </div>
            
            <div class="form-group">
              <label>T√™n ch·ªß th·∫ª *</label>
              <input type="text" id="card-holder" placeholder="NGUYEN VAN A">
            </div>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="agree-terms" required>
              T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" onclick="showContract()">ƒëi·ªÅu kho·∫£n d·ªãch v·ª•</a> v√† <a href="#" onclick="showContract()">ch√≠nh s√°ch b·∫£o m·∫≠t</a>
            </label>
          </div>
        </div>

        <div id="payment-step-2" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner" style="margin: 20px auto;"></div>
            <h3>ƒêang x·ª≠ l√Ω thanh to√°n...</h3>
            <p class="muted">Vui l√≤ng kh√¥ng ƒë√≥ng c·ª≠a s·ªï n√†y</p>
          </div>
        </div>

        <div id="payment-step-3" style="display: none;">
          <div class="text-center">
            <div style="font-size: 48px; color: var(--success); margin: 20px 0;">‚úÖ</div>
            <h3>Thanh to√°n th√†nh c√¥ng!</h3>
            <p class="muted">G√≥i d·ªãch v·ª• ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t</p>
            <button class="btn btn-primary" onclick="showContract()">Xem h·ª£p ƒë·ªìng ƒëi·ªán t·ª≠</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closePaymentModal()">H·ªßy</button>
        <button class="btn btn-primary" id="payment-btn" onclick="processPayment()">Thanh to√°n ngay</button>
      </div>
    </div>
  </div>

  <!-- Contract Modal -->
  <div id="contract-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>üìÑ H·ª£p ƒë·ªìng ƒëi·ªán t·ª≠</h2>
        <span class="close" onclick="closeContractModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="contract-content">
          <!-- Contract will be generated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="downloadContract()">üì• T·∫£i xu·ªëng PDF</button>
        <button class="btn btn-primary" onclick="closeContractModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    // Authentication System
    class AuthSystem {
      constructor() {
        this.currentUser = null;
        this.selectedPlanId = null;
        this.selectedPlan = null;
        this.selectedVehicleId = null;
        this.init();
      }

      init() {
        // Disable auto-login to prevent plan selection modal on page load
        // User must manually click login button
        
        // const savedUser = localStorage.getItem('currentUser');
        // if (savedUser) {
        //   this.currentUser = JSON.parse(savedUser);
        //   this.showDashboard();
        // }
      }

      login(username, password, role) {
        const demoUsers = {
          'user@demo.com': { role: 'user', name: 'Nguy·ªÖn VƒÉn User', password: '123456' },
          'staff@demo.com': { role: 'staff', name: 'Tr·∫ßn Th·ªã Staff', password: '123456' },
          'admin@demo.com': { role: 'admin', name: 'L√™ VƒÉn Admin', password: '123456' }
        };

        const user = demoUsers[username];
        if (user && user.password === password && user.role === role) {
          this.currentUser = {
            username,
            name: user.name,
            role: user.role,
            loginTime: new Date().toISOString()
          };
          localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
          this.showDashboard();
          return true;
        }
        return false;
      }

      logout() {
        this.currentUser = null;
        localStorage.removeItem('currentUser');
        this.showLandingPage();
        showToast('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng', 'success');
      }

      showDashboard() {
        if (!this.currentUser) return;

        // For users, check if they need to select plan/vehicle first
        if (this.currentUser.role === 'user') {
          // Only show plan selection if no plan is selected
          if (!this.currentUser.selectedPlan) {
            this.showPlanSelection();
            return;
          }
          
          // Only show vehicle selection if no vehicle is selected
          if (!this.currentUser.selectedVehicle) {
            this.showVehicleSelection();
            return;
          }
          
          // Both plan and vehicle are selected, proceed to dashboard
        }

        // Hide main content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        const role = this.currentUser.role;
        let dashboardId = role + 'Dashboard';
        
        // Create dashboard if it doesn't exist
        if (!document.getElementById(dashboardId)) {
          console.log('Creating dashboard for role:', role);
          this.createDashboard(role);
        }

        // Hide all dashboards first
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        
        // Show the correct dashboard
        const targetDashboard = document.getElementById(dashboardId);
        if (targetDashboard) {
          targetDashboard.classList.add('active');
          console.log('Dashboard activated:', dashboardId);
          showToast(`Ch√†o m·ª´ng ${this.currentUser.name}!`, 'success');
        } else {
          console.error('Dashboard not found:', dashboardId);
          showToast('L·ªói: Kh√¥ng th·ªÉ t·∫£i dashboard', 'error');
        }
      }

      showLandingPage() {
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        document.querySelector('main').style.display = 'block';
        document.querySelector('header').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
      }

      createDashboard(role) {
        const dashboardHtml = this.getDashboardHtml(role);
        document.body.insertAdjacentHTML('beforeend', dashboardHtml);
      }

      getDashboardHtml(role) {
        const dashboards = {
          user: this.getUserDashboardHtml(),
          staff: this.getStaffDashboardHtml(),
          admin: this.getAdminDashboardHtml()
        };
        return dashboards[role];
      }

      getUserDashboardHtml() {
        return `
          <div id="userDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Ng∆∞·ªùi D√πng
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">
                        ${this.currentUser.selectedVehicle ? 
                          `${this.currentUser.selectedVehicle.icon} ${this.currentUser.selectedVehicle.name}` : 
                          'Ng∆∞·ªùi d√πng'
                        }
                      </div>
                    </div>
                    <div class="vehicle-quick-info" style="margin: 0 15px; text-align: right;">
                      ${this.currentUser.selectedVehicle ? `
                        <div style="color: var(--brand); font-weight: 600;">${this.currentUser.selectedVehicle.currentCharge}%</div>
                        <div style="color: var(--muted); font-size: 0.8rem;">Pin hi·ªán t·∫°i</div>
                      ` : ''}
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">ƒêƒÉng xu·∫•t</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Dashboard Navigation -->
            <div class="user-nav">
              <div class="container">
                <div class="nav-tabs">
                  <button class="nav-tab active" onclick="showUserTab('overview')">üìä T·ªïng quan</button>
                  <button class="nav-tab" onclick="showUserTab('battery-swap')">üîã ƒê·ªïi pin ngay</button>
                  <button class="nav-tab" onclick="showUserTab('battery-health')">üíä T√¨nh tr·∫°ng pin</button>
                  <button class="nav-tab" onclick="showUserTab('payment-history')">üí≥ Thanh to√°n</button>
                  <button class="nav-tab" onclick="showUserTab('plans')">üì¶ G√≥i d·ªãch v·ª•</button>
                  <button class="nav-tab" onclick="showUserTab('map')">üó∫Ô∏è B·∫£n ƒë·ªì tr·∫°m</button>
                </div>
              </div>
            </div>

            <div class="dashboard-content">
              <div class="container">
                
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-value">12</div>
                      <div class="stat-label">L∆∞·ª£t ƒë·ªïi pin</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">1,240,000ƒë</div>
                      <div class="stat-label">T·ªïng chi ph√≠</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">Premium</div>
                      <div class="stat-label">G√≥i hi·ªán t·∫°i</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">4.8‚òÖ</div>
                      <div class="stat-label">ƒê√°nh gi√° c·ªßa b·∫°n</div>
                    </div>
                  </div>

                  <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div class="data-table">
                      <div class="table-header">
                        <h3>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
                      </div>
                      <table>
                        <thead>
                          <tr>
                            <th>Th·ªùi gian</th>
                            <th>Ho·∫°t ƒë·ªông</th>
                            <th>Tr·∫°ng th√°i</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>15/10/2025 14:30</td>
                            <td>ƒê·ªïi pin t·∫°i Tr·∫°m B√πi Th·ªã Xu√¢n</td>
                            <td><span class="status success">Ho√†n th√†nh</span></td>
                          </tr>
                          <tr>
                            <td>14/10/2025 10:20</td>
                            <td>N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</td>
                            <td><span class="status success">Th√†nh c√¥ng</span></td>
                          </tr>
                          <tr>
                            <td>12/10/2025 09:15</td>
                            <td>ƒê·ªïi pin t·∫°i Tr·∫°m C·∫ßu Gi·∫•y</td>
                            <td><span class="status success">Ho√†n th√†nh</span></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="card">
                      <h3>G√≥i d·ªãch v·ª• hi·ªán t·∫°i</h3>
                      <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--brand);">Premium</div>
                        <div class="muted">299,000ƒë/th√°ng</div>
                        <div style="margin: 16px 0;">
                          <div style="background: rgba(79,140,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: var(--brand); height: 100%; width: 60%; border-radius: 4px;"></div>
                          </div>
                          <div class="muted" style="margin-top: 8px;">4/8 l∆∞·ª£t ƒë√£ s·ª≠ d·ª•ng</div>
                        </div>
                      </div>
                      <button class="btn btn-primary" style="width: 100%;" onclick="showUserTab('plans')">Xem g√≥i kh√°c</button>
                    </div>
                  </div>
                </div>

                <!-- Battery Swap Tab -->
                <div id="battery-swap-tab" class="tab-content">
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                      <h3>üîã ƒê·ªïi pin ngay</h3>
                      <p class="muted">Ch·ªçn tr·∫°m v√† tr·ª• ƒë·ªÉ ƒë·ªïi pin t·ª± ƒë·ªông qua h·ªá th·ªëng IoT</p>
                      
                      <div class="form-group">
                        <label>üè¢ Ch·ªçn tr·∫°m ƒë·ªïi pin</label>
                        <select id="station-select" required onchange="loadStationPosts()">
                          <option value="">Ch·ªçn tr·∫°m ƒë·ªïi pin</option>
                          <option value="station1">Tr·∫°m B√πi Th·ªã Xu√¢n (8 pin s·∫µn s√†ng)</option>
                          <option value="station2">Tr·∫°m C·∫ßu Gi·∫•y (12 pin s·∫µn s√†ng)</option>
                          <option value="station3">Tr·∫°m Th·ªß ƒê·ª©c (15 pin s·∫µn s√†ng)</option>
                          <option value="station4">Tr·∫°m H·∫£i Ch√¢u (6 pin s·∫µn s√†ng)</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label>üîå Ch·ªçn tr·ª• ƒë·ªïi pin</label>
                        <div id="post-grid" style="display: none;">
                          <div class="post-grid" id="posts-container">
                            <!-- Posts will be loaded here -->
                          </div>
                        </div>
                        <div id="no-station" class="muted" style="text-align: center; padding: 20px;">
                          Vui l√≤ng ch·ªçn tr·∫°m ƒë·ªÉ xem c√°c tr·ª• ƒë·ªïi pin
                        </div>
                      </div>

                      <div class="form-group" id="selected-post-info" style="display: none;">
                        <div style="background: rgba(79,140,255,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(79,140,255,0.3);">
                          <h4 style="margin: 0 0 8px 0; color: var(--brand);">üìç Tr·ª• ƒë√£ ch·ªçn</h4>
                          <div id="post-details"></div>
                          
                          <!-- Slot selection -->
                          <div id="slot-selection" style="margin-top: 16px;">
                            <h5 style="margin: 0 0 8px 0;">Ch·ªçn slot ƒë·ªÉ l·∫•y pin:</h5>
                            <div id="available-slots" class="slot-grid"></div>
                            
                            <h5 style="margin: 16px 0 8px 0;">Ch·ªçn slot ƒë·ªÉ tr·∫£ pin c≈©:</h5>
                            <div id="empty-slots" class="slot-grid"></div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group" id="plan-status">
                        <div style="background: rgba(25,195,125,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(25,195,125,0.3);">
                          <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                              <span>  G√≥i Premium:</span><br>
                              <span class="muted">C√≤n l·∫°i 4/8 l∆∞·ª£t th√°ng n√†y</span>
                            </div>
                            <span style="font-size: 20px; font-weight: 700; color: var(--ok);">MI·ªÑN PH√ç</span>
                          </div>
                        </div>
                      </div>

                      <button type="button" class="btn btn-primary" style="width: 100%;" onclick="startBatterySwap()" id="swap-btn" disabled>
                        üöÄ B·∫Øt ƒë·∫ßu ƒë·ªïi pin
                      </button>
                    </div>

                    <div class="card">
                      <h3>  Tr·∫°ng th√°i ƒë·ªïi pin</h3>
                      <div id="swap-status" style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö°</div>
                        <h4>S·∫µn s√†ng ƒë·ªïi pin</h4>
                        <p class="muted">Ch·ªçn tr·∫°m v√† tr·ª• ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                      </div>

                      <div id="swap-progress" style="display: none;">
                        <div style="text-align: center; margin: 20px 0;">
                          <div style="width: 80px; height: 80px; border: 4px solid rgba(79,140,255,0.3); border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                          <style>
                            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                          </style>
                        </div>
                        <div id="progress-text" style="text-align: center;">
                          <h4>ƒêang k·∫øt n·ªëi v·ªõi tr·ª• pin...</h4>
                          <p class="muted">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
                        </div>
                      </div>

                      <h3 style="margin-top: 24px;">üïí L·ªãch s·ª≠ ƒë·ªïi pin g·∫ßn ƒë√¢y</h3>
                      <div style="max-height: 300px; overflow-y: auto;">
                        <table style="font-size: 13px;">
                          <thead>
                            <tr>
                              <th>Ng√†y</th>
                              <th>Tr·∫°m/Tr·ª•</th>
                              <th>Gi√°</th>
                              <th>Tr·∫°ng th√°i</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>15/10 14:30</td>
                              <td>BT Xu√¢n/A2</td>
                              <td>89,000ƒë</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                            </tr>
                            <tr>
                              <td>12/10 09:15</td>
                              <td>C·∫ßu Gi·∫•y/B1</td>
                              <td>89,000ƒë</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                            </tr>
                            <tr>
                              <td>08/10 16:45</td>
                              <td>Th·ªß ƒê·ª©c/C3</td>
                              <td>0ƒë (Premium)</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Battery Health Tab -->
                <div id="battery-health-tab" class="tab-content">
                  <div id="batteryHealthContent">
                    <div class="loading-message" style="text-align: center; padding: 60px 20px; color: var(--muted);">
                      <div class="loading-spinner" style="font-size: 2rem; margin-bottom: 15px;">üîÑ</div>
                      <p>ƒêang t·∫£i th√¥ng tin pin...</p>
                    </div>
                  </div>
                </div>

                <!-- Payment Tab -->
                <div id="payment-history-tab" class="tab-content">
                  <div class="payment-container">
                    <h3>üí≥ Qu·∫£n L√Ω Thanh To√°n</h3>
                    
                    <!-- Payment Sub-Navigation -->
                    <div class="payment-sub-nav">
                      <button class="payment-sub-tab active" onclick="showPaymentSubTab('history')">üìú L·ªãch s·ª≠ Payment</button>
                      <button class="payment-sub-tab" onclick="showPaymentSubTab('payment')">üí∞ Payment</button>
                      <button class="payment-sub-tab" onclick="showPaymentSubTab('autopay')">üîÑ Set Autopay</button>
                    </div>

                    <!-- Payment History Sub-Tab -->
                    <div id="payment-history-subtab" class="payment-sub-content active">
                      <div class="data-table">
                        <div class="table-header">
                          <h4>ÔøΩ L·ªãch s·ª≠ giao d·ªãch</h4>
                          <div class="table-filters">
                            <select class="filter-select" onchange="filterPaymentHistory()">
                              <option value="all">T·∫•t c·∫£ giao d·ªãch</option>
                              <option value="battery-swap">ƒê·ªïi pin</option>
                              <option value="plan-purchase">Mua g√≥i</option>
                              <option value="top-up">N·∫°p ti·ªÅn</option>
                              <option value="refund">Ho√†n ti·ªÅn</option>
                            </select>
                            <select class="filter-select" onchange="filterPaymentHistory()">
                              <option value="all">T·∫•t c·∫£ ph∆∞∆°ng th·ª©c</option>
                              <option value="credit-card">Th·∫ª t√≠n d·ª•ng</option>
                              <option value="momo">V√≠ MoMo</option>
                              <option value="zalopay">ZaloPay</option>
                              <option value="bank-transfer">Chuy·ªÉn kho·∫£n</option>
                            </select>
                            <input type="date" class="filter-input" onchange="filterPaymentHistory()">
                          </div>
                        </div>
                        <table>
                          <thead>
                            <tr>
                              <th>M√£ GD</th>
                              <th>Th·ªùi gian</th>
                              <th>Lo·∫°i giao d·ªãch</th>
                              <th>S·ªë ti·ªÅn</th>
                              <th>Ph∆∞∆°ng th·ª©c</th>
                              <th>Tr·∫°ng th√°i</th>
                              <th>Thao t√°c</th>
                            </tr>
                          </thead>
                          <tbody id="payment-history-table">
                            <tr>
                              <td>#PAY001</td>
                              <td>15/10/2025 14:35</td>
                              <td>ƒê·ªïi pin</td>
                              <td>89,000ƒë</td>
                              <td>V√≠ MoMo</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY001')">Chi ti·∫øt</button></td>
                            </tr>
                            <tr>
                              <td>#PAY002</td>
                              <td>14/10/2025 10:20</td>
                              <td>N·∫°p ti·ªÅn</td>
                              <td>500,000ƒë</td>
                              <td>Chuy·ªÉn kho·∫£n</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY002')">Chi ti·∫øt</button></td>
                            </tr>
                            <tr>
                              <td>#PAY003</td>
                              <td>12/10/2025 09:20</td>
                              <td>ƒê·ªïi pin</td>
                              <td>89,000ƒë</td>
                              <td>ZaloPay</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY003')">Chi ti·∫øt</button></td>
                            </tr>
                            <tr>
                              <td>#PAY004</td>
                              <td>10/10/2025 16:50</td>
                              <td>Mua g√≥i Premium</td>
                              <td id="plan-payment-amount">299,000ƒë</td>
                              <td>Th·∫ª t√≠n d·ª•ng</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY004')">Chi ti·∫øt</button></td>
                            </tr>
                            <tr>
                              <td>#PAY005</td>
                              <td>08/10/2025 16:50</td>
                              <td>ƒê·ªïi pin</td>
                              <td>0ƒë</td>
                              <td>G√≥i Premium</td>
                              <td><span class="status success">Th√†nh c√¥ng</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY005')">Chi ti·∫øt</button></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Payment Sub-Tab -->
                    <div id="payment-subtab" class="payment-sub-content">
                      <div class="payment-section">
                        <h4>üí∞ Thanh to√°n d·ª±a tr√™n g√≥i</h4>
                        <div class="current-plan-payment">
                          <div class="plan-payment-card">
                            <div class="plan-info">
                              <h5 id="current-plan-name">Premium Plan</h5>
                              <p id="current-plan-price">499,000 VNƒê/th√°ng</p>
                              <p class="plan-features" id="current-plan-features">5 l·∫ßn ƒë·ªïi pin/ng√†y ‚Ä¢ ∆Øu ti√™n h·ªó tr·ª£ ‚Ä¢ Xe m√°y ƒëi·ªán cao c·∫•p</p>
                            </div>
                            <div class="payment-status">
                              <span class="status success">ƒê√£ thanh to√°n</span>
                              <p class="next-payment">K·ª≥ ti·∫øp theo: <strong>01/11/2025</strong></p>
                            </div>
                          </div>
                          
                          <div class="payment-methods">
                            <h5>Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
                            <div class="payment-method-grid">
                              <div class="payment-method" onclick="selectPaymentMethod('momo')">
                                <div class="method-icon">üì±</div>
                                <div class="method-info">
                                  <h6>V√≠ MoMo</h6>
                                  <p>Thanh to√°n nhanh ch√≥ng</p>
                                </div>
                                <input type="radio" name="payment-method" value="momo">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('zalopay')">
                                <div class="method-icon">üí≥</div>
                                <div class="method-info">
                                  <h6>ZaloPay</h6>
                                  <p>V√≠ ƒëi·ªán t·ª≠ an to√†n</p>
                                </div>
                                <input type="radio" name="payment-method" value="zalopay">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('credit-card')">
                                <div class="method-icon">üíé</div>
                                <div class="method-info">
                                  <h6>Th·∫ª t√≠n d·ª•ng</h6>
                                  <p>Visa, MasterCard</p>
                                </div>
                                <input type="radio" name="payment-method" value="credit-card">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('bank-transfer')">
                                <div class="method-icon">üè¶</div>
                                <div class="method-info">
                                  <h6>Chuy·ªÉn kho·∫£n</h6>
                                  <p>Ng√¢n h√†ng tr·ª±c tuy·∫øn</p>
                                </div>
                                <input type="radio" name="payment-method" value="bank-transfer">
                              </div>
                            </div>
                            
                            <div class="payment-actions">
                              <button class="btn btn-primary" onclick="processPayment()">üí∞ Thanh to√°n ngay</button>
                              <button class="btn" onclick="showPaymentSubTab('autopay')">üîÑ Thi·∫øt l·∫≠p t·ª± ƒë·ªông</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Auto Pay Sub-Tab -->
                    <div id="autopay-subtab" class="payment-sub-content">
                      <div class="autopay-section">
                        <h4>üîÑ Thi·∫øt l·∫≠p thanh to√°n t·ª± ƒë·ªông</h4>
                        
                        <div class="autopay-status">
                          <div class="autopay-toggle">
                            <label class="switch">
                              <input type="checkbox" id="autopay-enabled" onchange="toggleAutoPay()">
                              <span class="slider round"></span>
                            </label>
                            <div class="autopay-info">
                              <h5>Thanh to√°n t·ª± ƒë·ªông</h5>
                              <p id="autopay-status-text">T·∫Øt - B·∫°n s·∫Ω thanh to√°n th·ªß c√¥ng m·ªói th√°ng</p>
                            </div>
                          </div>
                        </div>

                        <div class="autopay-settings" id="autopay-settings" style="display: none;">
                          <div class="setting-group">
                            <h5>üìÖ Ng√†y thanh to√°n</h5>
                            <select id="autopay-day" onchange="updateAutoPaySettings()">
                              <option value="1">Ng√†y 1 m·ªói th√°ng</option>
                              <option value="15">Ng√†y 15 m·ªói th√°ng</option>
                              <option value="end">Cu·ªëi th√°ng</option>
                            </select>
                          </div>

                          <div class="setting-group">
                            <h5>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n m·∫∑c ƒë·ªãnh</h5>
                            <div class="autopay-method-selection">
                              <div class="autopay-method" onclick="selectAutoPayMethod('momo')">
                                <input type="radio" name="autopay-method" value="momo" checked>
                                <div class="method-icon">üì±</div>
                                <span>V√≠ MoMo</span>
                              </div>
                              <div class="autopay-method" onclick="selectAutoPayMethod('credit-card')">
                                <input type="radio" name="autopay-method" value="credit-card">
                                <div class="method-icon">üíé</div>
                                <span>Th·∫ª t√≠n d·ª•ng</span>
                              </div>
                            </div>
                          </div>

                          <div class="setting-group">
                            <h5>üìß Th√¥ng b√°o</h5>
                            <div class="notification-settings">
                              <label class="checkbox-label">
                                <input type="checkbox" checked> Email th√¥ng b√°o tr∆∞·ªõc 3 ng√†y
                              </label>
                              <label class="checkbox-label">
                                <input type="checkbox" checked> SMS th√¥ng b√°o khi thanh to√°n th√†nh c√¥ng
                              </label>
                              <label class="checkbox-label">
                                <input type="checkbox"> Th√¥ng b√°o khi thanh to√°n th·∫•t b·∫°i
                              </label>
                            </div>
                          </div>

                          <div class="autopay-actions">
                            <button class="btn btn-primary" onclick="saveAutoPaySettings()">üíæ L∆∞u c√†i ƒë·∫∑t</button>
                            <button class="btn btn-secondary" onclick="testAutoPay()">üß™ Test thanh to√°n</button>
                          </div>
                        </div>

                        <div class="autopay-history">
                          <h5>üìä L·ªãch s·ª≠ thanh to√°n t·ª± ƒë·ªông</h5>
                          <div class="autopay-history-list">
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/10/2025</span>
                                <span class="record-amount">499,000ƒë</span>
                              </div>
                              <span class="status success">Th√†nh c√¥ng</span>
                            </div>
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/09/2025</span>
                                <span class="record-amount">499,000ƒë</span>
                              </div>
                              <span class="status success">Th√†nh c√¥ng</span>
                            </div>
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/08/2025</span>
                                <span class="record-amount">299,000ƒë</span>
                              </div>
                              <span class="status success">Th√†nh c√¥ng</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Plans Tab -->
                <div id="plans-tab" class="tab-content">
                  <h2>üì¶ Ch·ªçn g√≥i d·ªãch v·ª• ph√π h·ª£p</h2>
                  <p class="muted">Ti·∫øt ki·ªám chi ph√≠ v·ªõi c√°c g√≥i d·ªãch v·ª• linh ho·∫°t</p>
                  
                  <div class="pricing">
                    <div class="card">
                      <h3>C∆° b·∫£n</h3>
                      <div class="price">89.000ƒë/l∆∞·ª£t</div>
                      <ul class="clean">
                        <li><span class="tick">‚úì</span> Thanh to√°n theo l∆∞·ª£t</li>
                        <li><span class="tick">‚úì</span> Kh√¥ng cam k·∫øt d√†i h·∫°n</li>
                        <li><span class="tick">‚úì</span> Ph√π h·ª£p s·ª≠ d·ª•ng th·ªânh tho·∫£ng</li>
                        <li><span class="tick">‚úì</span> H·ªó tr·ª£ qua hotline</li>
                      </ul>
                      <button class="btn" onclick="selectPlan('basic')">ƒêang s·ª≠ d·ª•ng</button>
                    </div>
                    
                    <div class="card featured">
                      <h3>Premium <span class="chip">Ph·ªï bi·∫øn</span></h3>
                      <div class="price">299.000ƒë/th√°ng</div>
                      <div class="muted">Ti·∫øt ki·ªám 46% so v·ªõi tr·∫£ theo l∆∞·ª£t</div>
                      <ul class="clean">
                        <li><span class="tick">‚úì</span> 8 l∆∞·ª£t ƒë·ªïi pin/th√°ng</li>
                        <li><span class="tick">‚úì</span> ∆Øu ti√™n t·∫°i tr·∫°m</li>
                        <li><span class="tick">‚úì</span> H·ªó tr·ª£ 24/7</li>
                        <li><span class="tick">‚úì</span> B√°o c√°o chi ti·∫øt</li>
                        <li><span class="tick">‚úì</span> Mi·ªÖn ph√≠ l∆∞·ª£t ƒë·∫ßu m·ªói ng√†y</li>
                      </ul>
                      <button class="btn btn-primary" onclick="purchasePlan('premium', 'G√≥i Premium', 299000, '8 l∆∞·ª£t ƒë·ªïi pin/th√°ng ‚Ä¢ ∆Øu ti√™n t·∫°i tr·∫°m ‚Ä¢ H·ªó tr·ª£ 24/7')">Mua g√≥i n√†y</button>
                    </div>
                    
                    <div class="card">
                      <h3>Enterprise</h3>
                      <div class="price">899.000ƒë/th√°ng</div>
                      <div class="muted">Cho doanh nghi·ªáp v·∫≠n t·∫£i</div>
                      <ul class="clean">
                        <li><span class="tick">‚úì</span> Kh√¥ng gi·ªõi h·∫°n l∆∞·ª£t ƒë·ªïi</li>
                        <li><span class="tick">‚úì</span> API t√≠ch h·ª£p</li>
                        <li><span class="tick">‚úì</span> Dashboard qu·∫£n l√Ω ƒë·ªôi xe</li>
                        <li><span class="tick">‚úì</span> H·ªó tr·ª£ k·ªπ thu·∫≠t ri√™ng</li>
                        <li><span class="tick">‚úì</span> B√°o c√°o t√πy ch·ªânh</li>
                      </ul>
                      <button class="btn btn-primary" onclick="purchasePlan('enterprise', 'G√≥i Enterprise', 899000, 'Kh√¥ng gi·ªõi h·∫°n l∆∞·ª£t ƒë·ªïi ‚Ä¢ API t√≠ch h·ª£p ‚Ä¢ Dashboard qu·∫£n l√Ω ƒë·ªôi xe')">Mua g√≥i n√†y</button>
                    </div>
                  </div>

                  <div class="card" style="margin-top: 24px;">
                    <h3>üí∞ N·∫°p ti·ªÅn v√†o t√†i kho·∫£n</h3>
                    <p class="muted">N·∫°p tr∆∞·ªõc ƒë·ªÉ thanh to√°n nhanh ch√≥ng h∆°n</p>
                    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                      <div>
                        <div class="form-group">
                          <label>S·ªë ti·ªÅn n·∫°p</label>
                          <select id="top-up-amount" onchange="updateTopUpAmount()">
                            <option value="100000">100,000ƒë</option>
                            <option value="200000">200,000ƒë (+10,000ƒë bonus)</option>
                            <option value="500000">500,000ƒë (+30,000ƒë bonus)</option>
                            <option value="1000000">1,000,000ƒë (+80,000ƒë bonus)</option>
                            <option value="custom">S·ªë ti·ªÅn kh√°c</option>
                          </select>
                          <input type="number" id="custom-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" style="display: none; margin-top: 8px;" min="50000" step="10000">
                        </div>
                        <div class="form-group">
                          <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                          <select>
                            <option value="momo">V√≠ MoMo</option>
                            <option value="zalopay">ZaloPay</option>
                            <option value="vnpay">VNPay</option>
                            <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                            <option value="credit-card">Th·∫ª t√≠n d·ª•ng/ghi n·ª£</option>
                          </select>
                        </div>
                      </div>
                      <div>
                        <div style="background: rgba(79,140,255,0.1); padding: 16px; border-radius: 8px; text-align: center;">
                          <div style="font-size: 18px; font-weight: 600;">S·ªë d∆∞ hi·ªán t·∫°i</div>
                          <div style="font-size: 28px; font-weight: 800; color: var(--brand); margin: 8px 0;">156,000ƒë</div>
                          <button class="btn btn-primary" onclick="processTopUp()">N·∫°p ti·ªÅn</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Map Tab -->
                <div id="map-tab" class="tab-content">
                  <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div class="card">
                      <h3>üó∫Ô∏è B·∫£n ƒë·ªì tr·∫°m ƒë·ªïi pin</h3>
                      <div id="user-map" style="height: 500px; border-radius: 12px; overflow: hidden; margin-top: 16px;"></div>
                      <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn" onclick="findMyLocation()">üìç V·ªã tr√≠ c·ªßa t√¥i</button>
                        <button class="btn" onclick="filterActiveStations()">üü¢ Ch·ªâ tr·∫°m ho·∫°t ƒë·ªông</button>
                        <button class="btn" onclick="showAllStations()">üîÑ Hi·ªán t·∫•t c·∫£</button>
                      </div>
                    </div>

                    <div>
                      <div class="card" style="margin-bottom: 20px;">
                        <h3>üìä Th√¥ng tin tr·∫°m ƒë√£ ch·ªçn</h3>
                        <div id="selected-station-info">
                          <p class="muted">Click v√†o tr·∫°m tr√™n b·∫£n ƒë·ªì ƒë·ªÉ xem th√¥ng tin chi ti·∫øt</p>
                        </div>
                      </div>

                      <div class="card">
                        <h3>üîç T√¨m ki·∫øm tr·∫°m</h3>
                        <div class="form-group">
                          <input type="text" placeholder="T√¨m theo t√™n tr·∫°m ho·∫∑c ƒë·ªãa ch·ªâ..." id="station-search" onkeyup="searchStations()">
                        </div>
                        <div class="form-group">
                          <select onchange="filterByDistance()">
                            <option value="all">T·∫•t c·∫£ kho·∫£ng c√°ch</option>
                            <option value="1">Trong v√≤ng 1km</option>
                            <option value="3">Trong v√≤ng 3km</option>
                            <option value="5">Trong v√≤ng 5km</option>
                            <option value="10">Trong v√≤ng 10km</option>
                          </select>
                        </div>

                        <h4>üìã Danh s√°ch tr·∫°m g·∫ßn</h4>
                        <div id="nearby-stations" style="max-height: 200px; overflow-y: auto;">
                          <div class="station-item" onclick="focusStation('station1')">
                            <strong>Tr·∫°m B√πi Th·ªã Xu√¢n</strong><br>
                            <span class="muted">Qu·∫≠n 1, TP.HCM ‚Ä¢ 0.8km</span><br>
                            <span class="status success">8 pin s·∫µn s√†ng</span>
                          </div>
                          <div class="station-item" onclick="focusStation('station2')">
                            <strong>Tr·∫°m C·∫ßu Gi·∫•y</strong><br>
                            <span class="muted">C·∫ßu Gi·∫•y, H√† N·ªôi ‚Ä¢ 2.1km</span><br>
                            <span class="status success">12 pin s·∫µn s√†ng</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;
      }

      getStaffDashboardHtml() {
        return `
          <div id="staffDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Nh√¢n Vi√™n
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">Nh√¢n vi√™n</div>
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">ƒêƒÉng xu·∫•t</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-content">
              <div class="container">
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">24</div>
                    <div class="stat-label">Pin s·∫µn s√†ng</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">6</div>
                    <div class="stat-label">Pin ƒëang s·∫°c</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">18</div>
                    <div class="stat-label">ƒê·ªïi pin h√¥m nay</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">95%</div>
                    <div class="stat-label">Hi·ªáu su·∫•t tr·∫°m</div>
                  </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                  <div class="data-table">
                    <div class="table-header">
                      <h3>Qu·∫£n l√Ω pin</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">T·∫•t c·∫£</option>
                          <option value="ready">S·∫µn s√†ng</option>
                          <option value="charging">ƒêang s·∫°c</option>
                          <option value="maintenance">B·∫£o tr√¨</option>
                        </select>
                      </div>
                    </div>
                    <table>
                      <thead>
                        <tr>
                          <th>ID Pin</th>
                          <th>Lo·∫°i</th>
                          <th>T√¨nh tr·∫°ng</th>
                          <th>Pin (%)</th>
                          <th>Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>#B001</td>
                          <td>72V 20Ah</td>
                          <td><span class="status success">S·∫µn s√†ng</span></td>
                          <td>100%</td>
                          <td><button class="action-btn">Qu·∫£n l√Ω</button></td>
                        </tr>
                        <tr>
                          <td>#B002</td>
                          <td>72V 32Ah</td>
                          <td><span class="status warning">ƒêang s·∫°c</span></td>
                          <td>85%</td>
                          <td><button class="action-btn">Qu·∫£n l√Ω</button></td>
                        </tr>
                        <tr>
                          <td>#B003</td>
                          <td>72V 20Ah</td>
                          <td><span class="status success">S·∫µn s√†ng</span></td>
                          <td>98%</td>
                          <td><button class="action-btn">Qu·∫£n l√Ω</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="data-table">
                    <div class="table-header">
                      <h3>Y√™u c·∫ßu ƒë·ªïi pin</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">T·∫•t c·∫£</option>
                          <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                          <option value="processing">ƒêang x·ª≠ l√Ω</option>
                          <option value="completed">Ho√†n th√†nh</option>
                        </select>
                      </div>
                    </div>
                    <table>
                      <thead>
                        <tr>
                          <th>Kh√°ch h√†ng</th>
                          <th>Th·ªùi gian</th>
                          <th>Tr·∫°ng th√°i</th>
                          <th>Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>Nguy·ªÖn VƒÉn A</td>
                          <td>16:30</td>
                          <td><span class="status warning">Ch·ªù x·ª≠ l√Ω</span></td>
                          <td><button class="action-btn btn-primary">X·ª≠ l√Ω</button></td>
                        </tr>
                        <tr>
                          <td>Tr·∫ßn Th·ªã B</td>
                          <td>15:45</td>
                          <td><span class="status warning">ƒêang x·ª≠ l√Ω</span></td>
                          <td><button class="action-btn btn-success">Ho√†n th√†nh</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      getAdminDashboardHtml() {
        return `
          <div id="adminDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Qu·∫£n Tr·ªã
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">Qu·∫£n tr·ªã vi√™n</div>
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">ƒêƒÉng xu·∫•t</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-content">
              <div class="container">
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">1,247</div>
                    <div class="stat-label">Ng∆∞·ªùi d√πng</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">24</div>
                    <div class="stat-label">Tr·∫°m ho·∫°t ƒë·ªông</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">52.8M</div>
                    <div class="stat-label">Doanh thu (VNƒê)</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">98.2%</div>
                    <div class="stat-label">Uptime h·ªá th·ªëng</div>
                  </div>
                </div>

                <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                  <div class="data-table">
                    <div class="table-header">
                      <h3>Qu·∫£n l√Ω thanh to√°n</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">T·∫•t c·∫£</option>
                          <option value="success">Th√†nh c√¥ng</option>
                          <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                          <option value="failed">Th·∫•t b·∫°i</option>
                        </select>
                        <select class="filter-select">
                          <option value="all">T·∫•t c·∫£ ph∆∞∆°ng th·ª©c</option>
                          <option value="qr">QR Code</option>
                          <option value="card">Th·∫ª t√≠n d·ª•ng</option>
                          <option value="wallet">V√≠ ƒëi·ªán t·ª≠</option>
                        </select>
                        <input type="date" class="filter-input">
                      </div>
                    </div>
                    <table>
                      <thead>
                        <tr>
                          <th>M√£ GD</th>
                          <th>Kh√°ch h√†ng</th>
                          <th>S·ªë ti·ªÅn</th>
                          <th>Ph∆∞∆°ng th·ª©c</th>
                          <th>Tr·∫°ng th√°i</th>
                          <th>Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>#TX001</td>
                          <td>Nguy·ªÖn VƒÉn A</td>
                          <td>89,000ƒë</td>
                          <td>QR Code</td>
                          <td><span class="status success">Th√†nh c√¥ng</span></td>
                          <td><button class="action-btn">Chi ti·∫øt</button></td>
                        </tr>
                        <tr>
                          <td>#TX002</td>
                          <td>Tr·∫ßn Th·ªã B</td>
                          <td>299,000ƒë</td>
                          <td>V√≠ ƒëi·ªán t·ª≠</td>
                          <td><span class="status warning">Ch·ªù x·ª≠ l√Ω</span></td>
                          <td><button class="action-btn">X·ª≠ l√Ω</button></td>
                        </tr>
                        <tr>
                          <td>#TX003</td>
                          <td>L√™ VƒÉn C</td>
                          <td>89,000ƒë</td>
                          <td>Th·∫ª t√≠n d·ª•ng</td>
                          <td><span class="status danger">Th·∫•t b·∫°i</span></td>
                          <td><button class="action-btn">Ho√†n ti·ªÅn</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div>
                    <div class="card" style="margin-bottom: 20px;">
                      <h3>Th·ªëng k√™ tr·∫°m</h3>
                      <div style="margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Tr·∫°m ho·∫°t ƒë·ªông:</span>
                          <span style="color: var(--ok);">24/26</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Tr·∫°m b·∫£o tr√¨:</span>
                          <span style="color: var(--warn);">2/26</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Pin s·∫µn s√†ng:</span>
                          <span style="color: var(--ok);">342/400</span>
                        </div>
                      </div>
                      <button class="btn btn-primary" style="width: 100%;">Qu·∫£n l√Ω tr·∫°m</button>
                    </div>

                    <div class="card">
                      <h3>H√†nh ƒë·ªông nhanh</h3>
                      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                        <button class="btn">üìä Xu·∫•t b√°o c√°o</button>
                        <button class="btn">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</button>
                        <button class="btn">‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</button>
                        <button class="btn">üìã Xem logs</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      showVehicleSelection() {
        // Hide other content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        // Remove existing vehicle selection modal if any
        const existing = document.getElementById('vehicleSelectionModal');
        if (existing) existing.remove();

        // Get vehicles from selected plan
        let userVehicles = [];
        if (this.currentUser.selectedPlan && this.currentUser.selectedPlan.vehicles) {
          userVehicles = this.currentUser.selectedPlan.vehicles.map(vehicle => ({
            id: vehicle.id,
            name: vehicle.name,
            icon: vehicle.icon,
            batteryCapacity: vehicle.batteryCapacity,
            description: vehicle.description,
            currentCharge: Math.floor(Math.random() * 30) + 70, // Random charge 70-100%
            health: Math.floor(Math.random() * 10) + 90, // Random health 90-100%
            type: 'scooter',
            batteryId: `BAT_${vehicle.id}`,
            cycleCount: Math.floor(Math.random() * 200) + 50,
            manufactureDate: '2024-01-01',
            lastChecked: new Date().toISOString(),
            planId: this.currentUser.selectedPlan.id,
            planName: this.currentUser.selectedPlan.name
          }));
        } else {
          // Fallback vehicles if no plan selected
          userVehicles = [
            {
              id: 'FALLBACK_001',
              name: 'VinFast Klara A2',
              icon: 'üõµ',
              batteryCapacity: 2.5,
              currentCharge: 85,
              health: 95
            }
          ];
        }

        // Create vehicle selection modal
        const modal = document.createElement('div');
        modal.id = 'vehicleSelectionModal';
        modal.className = 'vehicle-selection-modal';
        modal.innerHTML = `
          <div class="vehicle-selection-content">
            <div class="vehicle-selection-header">
              <h2>üèçÔ∏è Ch·ªçn Xe Cho ${this.currentUser.selectedPlan ? this.currentUser.selectedPlan.name : 'Plan'}</h2>
              <p>Ch·ªçn xe m√°y ƒëi·ªán t·ª´ g√≥i ${this.currentUser.selectedPlan ? this.currentUser.selectedPlan.name : ''} c·ªßa b·∫°n</p>
              ${this.currentUser.selectedPlan ? `
                <div class="selected-plan-info">
                  <span class="plan-badge" style="background: ${this.currentUser.selectedPlan.color}">
                    ${this.currentUser.selectedPlan.icon} ${this.currentUser.selectedPlan.name}
                  </span>
                </div>
              ` : ''}
            </div>
            <div class="vehicles-grid">
              ${userVehicles.map(vehicle => `
                <div class="vehicle-option" data-vehicle-id="${vehicle.id}">
                  <span class="vehicle-icon">${vehicle.icon}</span>
                  <div class="vehicle-name">${vehicle.name}</div>
                  <div class="vehicle-details">
                    Pin: ${vehicle.batteryCapacity} kWh<br>
                    M√£: ${vehicle.id}
                    ${vehicle.description ? `<br><small style="color: #888;">${vehicle.description}</small>` : ''}
                  </div>
                  <div class="vehicle-battery">
                    ${vehicle.currentCharge}% pin - ${vehicle.health}% health
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="auth.selectVehicleAndContinue()" disabled id="continueBtn">
                Ti·∫øp t·ª•c v√†o Dashboard
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for vehicle selection
        modal.querySelectorAll('.vehicle-option').forEach(option => {
          option.addEventListener('click', () => {
            // Remove selected class from all options
            modal.querySelectorAll('.vehicle-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked option
            option.classList.add('selected');
            // Enable continue button
            document.getElementById('continueBtn').disabled = false;
            // Store selected vehicle id
            this.selectedVehicleId = option.dataset.vehicleId;
          });
        });
      }

      selectVehicleAndContinue() {
        if (!this.selectedVehicleId) {
          console.error('No vehicle selected');
          showToast('Vui l√≤ng ch·ªçn m·ªôt xe tr∆∞·ªõc khi ti·∫øp t·ª•c', 'warning');
          return;
        }

        // Get vehicles from selected plan (same logic as showVehicleSelection)
        let userVehicles = [];
        if (this.currentUser.selectedPlan && this.currentUser.selectedPlan.vehicles) {
          userVehicles = this.currentUser.selectedPlan.vehicles.map(vehicle => ({
            id: vehicle.id,
            name: vehicle.name,
            icon: vehicle.icon,
            batteryCapacity: vehicle.batteryCapacity,
            description: vehicle.description,
            currentCharge: Math.floor(Math.random() * 30) + 70,
            health: Math.floor(Math.random() * 10) + 90,
            type: 'scooter',
            batteryId: `BAT_${vehicle.id}`,
            cycleCount: Math.floor(Math.random() * 200) + 50,
            manufactureDate: '2024-01-01',
            lastChecked: new Date().toISOString(),
            planId: this.currentUser.selectedPlan.id,
            planName: this.currentUser.selectedPlan.name
          }));
        } else {
          console.error('No plan selected or plan has no vehicles');
          showToast('L·ªói: Kh√¥ng c√≥ g√≥i d·ªãch v·ª• ho·∫∑c xe n√†o ƒë∆∞·ª£c ch·ªçn', 'error');
          return;
        }

        const selectedVehicle = userVehicles.find(v => v.id === this.selectedVehicleId);
        if (selectedVehicle) {
          // Store selected vehicle in current user
          this.currentUser.selectedVehicle = selectedVehicle;
          localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

          console.log('Vehicle selected successfully:', selectedVehicle.name);
          showToast(`ƒê√£ ch·ªçn xe ${selectedVehicle.name}`, 'success');

          // Remove modal
          const modal = document.getElementById('vehicleSelectionModal');
          if (modal) modal.remove();

          // Continue to dashboard
          this.showDashboard();
        } else {
          console.error('Selected vehicle not found');
          showToast('L·ªói: Kh√¥ng t√¨m th·∫•y xe ƒë√£ ch·ªçn', 'error');
        }
      }

      showPlanSelection() {
        // Hide other content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        // Remove existing plan selection modal if any
        const existing = document.getElementById('planSelectionModal');
        if (existing) existing.remove();

        // Define available plans
        const plans = [
          {
            id: 'basic',
            name: 'Basic Plan',
            icon: 'ü•â',
            price: '299,000 VNƒê/th√°ng',
            features: ['2 l·∫ßn ƒë·ªïi pin/ng√†y', 'H·ªó tr·ª£ 24/7', 'Xe m√°y ƒëi·ªán c∆° b·∫£n'],
            vehicles: [
              { id: 'BASIC_001', name: 'VinFast Klara A1', icon: 'üõ¥', batteryCapacity: 1.3, description: 'Xe c∆° b·∫£n, ph√π h·ª£p di chuy·ªÉn trong th√†nh ph·ªë' }
            ],
            color: '#6c757d'
          },
          {
            id: 'premium',
            name: 'Premium Plan',
            icon: 'ü•à',
            price: '499,000 VNƒê/th√°ng',
            features: ['5 l·∫ßn ƒë·ªïi pin/ng√†y', '∆Øu ti√™n h·ªó tr·ª£', 'Xe m√°y ƒëi·ªán cao c·∫•p', 'Th·ªëng k√™ pin chi ti·∫øt'],
            vehicles: [
              { id: 'PREMIUM_001', name: 'VinFast Klara A2', icon: 'üõµ', batteryCapacity: 2.5, description: 'Xe cao c·∫•p v·ªõi pin l·ªõn v√† t√≠nh nƒÉng th√¥ng minh' },
              { id: 'PREMIUM_002', name: 'VinFast Ludo', icon: 'üõ¥', batteryCapacity: 1.8, description: 'Thi·∫øt k·∫ø hi·ªán ƒë·∫°i, ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng' }
            ],
            color: '#6f42c1'
          },
          {
            id: 'vip',
            name: 'VIP Plan',
            icon: 'ü•á',
            price: '799,000 VNƒê/th√°ng',
            features: ['Kh√¥ng gi·ªõi h·∫°n ƒë·ªïi pin', 'H·ªó tr·ª£ VIP 24/7', 'Xe m√°y ƒëi·ªán cao c·∫•p nh·∫•t', 'AI t·ªëi ∆∞u pin', 'B·∫£o h√†nh to√†n di·ªán'],
            vehicles: [
              { id: 'VIP_001', name: 'Honda PCX Electric', icon: 'üèçÔ∏è', batteryCapacity: 1.3, description: 'Xe ƒëi·ªán cao c·∫•p t·ª´ Honda v·ªõi c√¥ng ngh·ªá ti√™n ti·∫øn' },
              { id: 'VIP_002', name: 'VinFast Klara A2 Pro', icon: 'üõµ', batteryCapacity: 3.0, description: 'Phi√™n b·∫£n Pro v·ªõi pin si√™u l·ªõn v√† t√≠nh nƒÉng AI' },
              { id: 'VIP_003', name: 'Yamaha E-Vino', icon: 'üèçÔ∏è', batteryCapacity: 2.2, description: 'Thi·∫øt k·∫ø Nh·∫≠t B·∫£n v·ªõi hi·ªáu su·∫•t v∆∞·ª£t tr·ªôi' }
            ],
            color: '#ffc107'
          }
        ];

        // Create plan selection modal
        const modal = document.createElement('div');
        modal.id = 'planSelectionModal';
        modal.className = 'plan-selection-modal';
        modal.innerHTML = `
          <div class="plan-selection-content">
            <div class="plan-selection-header">
              <h2>üìã Ch·ªçn G√≥i D·ªãch V·ª•</h2>
              <p>Ch·ªçn g√≥i d·ªãch v·ª• ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa b·∫°n</p>
            </div>
            <div class="plans-grid">
              ${plans.map(plan => `
                <div class="plan-option" data-plan-id="${plan.id}" style="border-color: ${plan.color}">
                  <div class="plan-header" style="background: ${plan.color}">
                    <span class="plan-icon">${plan.icon}</span>
                    <h3>${plan.name}</h3>
                    <div class="plan-price">${plan.price}</div>
                  </div>
                  <div class="plan-features">
                    <h4>T√≠nh nƒÉng:</h4>
                    <ul>
                      ${plan.features.map(feature => `<li>‚úì ${feature}</li>`).join('')}
                    </ul>
                    <h4>Xe c√≥ s·∫µn:</h4>
                    <div class="plan-vehicles">
                      ${plan.vehicles.map(vehicle => `
                        <div class="vehicle-preview">
                          <span>${vehicle.icon}</span>
                          <div>
                            <strong>${vehicle.name}</strong><br>
                            <small>Pin: ${vehicle.batteryCapacity} kWh</small>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="auth.selectPlanAndContinue()" disabled id="planContinueBtn">
                Ti·∫øp t·ª•c ch·ªçn xe
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for plan selection
        modal.querySelectorAll('.plan-option').forEach(option => {
          option.addEventListener('click', () => {
            // Remove selected class from all options
            modal.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked option
            option.classList.add('selected');
            // Enable continue button
            document.getElementById('planContinueBtn').disabled = false;
            // Store selected plan id
            this.selectedPlanId = option.dataset.planId;
            this.selectedPlan = plans.find(p => p.id === this.selectedPlanId);
          });
        });
      }

      selectPlanAndContinue() {
        if (!this.selectedPlan) return;

        // Store selected plan in current user
        this.currentUser.selectedPlan = this.selectedPlan;
        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

        // Remove plan modal
        const modal = document.getElementById('planSelectionModal');
        if (modal) modal.remove();

        // Show vehicle selection for the selected plan
        this.showVehicleSelection();
      }
    }

    // Global auth instance
    const auth = new AuthSystem();

    // Map functionality
    let map;
    const stations = [
      { name: "Tr·∫°m B√πi Th·ªã Xu√¢n", lat: 10.7769, lng: 106.7009, area: "Qu·∫≠n 1, TP.HCM", status: "active", pins: 8 },
      { name: "Tr·∫°m C·∫ßu Gi·∫•y", lat: 21.0285, lng: 105.8542, area: "C·∫ßu Gi·∫•y, H√† N·ªôi", status: "active", pins: 12 },
      { name: "Tr·∫°m H·∫£i Ch√¢u", lat: 16.0678, lng: 108.2208, area: "H·∫£i Ch√¢u, ƒê√† N·∫µng", status: "active", pins: 6 },
      { name: "Tr·∫°m Th·ªß ƒê·ª©c", lat: 10.8411, lng: 106.8108, area: "TP. Th·ªß ƒê·ª©c, TP.HCM", status: "active", pins: 15 },
      { name: "Tr·∫°m Long Bi√™n", lat: 21.0467, lng: 105.8917, area: "Long Bi√™n, H√† N·ªôi", status: "maintenance", pins: 0 },
      { name: "Tr·∫°m S∆°n Tr√†", lat: 16.1097, lng: 108.2597, area: "S∆°n Tr√†, ƒê√† N·∫µng", status: "active", pins: 9 }
    ];

    function initMap() {
      try {
        console.log('Creating map...');
        
        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
          throw new Error('Leaflet library not loaded');
        }
        
        // Check if map container exists
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
          throw new Error('Map container not found');
        }
        
        console.log('Map container found, creating Leaflet map...');
        map = L.map('map').setView([16.0678, 108.2208], 6);
        console.log('Leaflet map created');
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        console.log('Tile layer added');

        stations.forEach(station => {
          const color = station.status === 'active' ? 'green' : 'red';
          const icon = L.divIcon({
            html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            className: 'custom-div-icon'
          });

          const marker = L.marker([station.lat, station.lng], { icon })
            .addTo(map)
            .bindPopup(`
              <strong>${station.name}</strong><br>
              ${station.area}<br>
              Pin s·∫µn s√†ng: ${station.pins}<br>
              Tr·∫°ng th√°i: ${station.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'B·∫£o tr√¨'}
            `);
        });
        
        console.log('Map initialization completed successfully');
      } catch (error) {
        console.error('Error in initMap():', error);
        // Show error message in map container
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 400px; background: #1a1a2e; color: white; text-align: center; border-radius: 8px;">
              <div>
                <h3>‚ùå L·ªói t·∫£i b·∫£n ƒë·ªì</h3>
                <p>Kh√¥ng th·ªÉ t·∫£i Leaflet map: ${error.message}</p>
                <button onclick="location.reload()" style="background: #4f8cff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Refresh</button>
              </div>
            </div>
          `;
        }
      }
    }

    // Fixed showLogin function
    function showLogin() {
      console.log('showLogin() called');
      
      // Close any existing modals first
      closeModal('registerModal');
      
      const modal = document.getElementById('loginModal');
      if (modal) {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        console.log('Login modal opened successfully');
      } else {
        console.error('loginModal element not found');
        showToast('L·ªói: Kh√¥ng th·ªÉ m·ªü modal ƒëƒÉng nh·∫≠p', 'error');
      }
    }

    function showRegister() {
      console.log('showRegister() called');
      
      // Close any existing modals first
      closeModal('loginModal');
      
      const modal = document.getElementById('registerModal');
      if (modal) {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        console.log('Register modal opened successfully');
      } else {
        console.error('registerModal element not found');
        showToast('L·ªói: Kh√¥ng th·ªÉ m·ªü modal ƒëƒÉng k√Ω', 'error');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
    }

    function quickLogin(role, username, password) {
      document.getElementById('username').value = username;
      document.getElementById('password').value = password;
      document.getElementById('userRole').value = role;
      handleLogin(new Event('submit'));
    }

    function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const role = document.getElementById('userRole').value;

      if (auth.login(username, password, role)) {
        showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        closeModal('loginModal');
      } else {
        showToast('Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng!', 'error');
      }
      return false;
    }

    function handleRegister(event) {
      event.preventDefault();
      showToast('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.', 'success');
      closeModal('registerModal');
      showLogin();
      return false;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function scrollToId(id) {
      document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function showContact() {
      scrollToId('contact');
    }

    function findNearestStation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          map.setView([lat, lng], 12);
          showToast('ƒê√£ t√¨m tr·∫°m g·∫ßn nh·∫•t d·ª±a tr√™n v·ªã tr√≠ c·ªßa b·∫°n', 'success');
        });
      } else {
        showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã', 'warning');
      }
    }

    // Initialize with error handling
    window.addEventListener('load', () => {
      console.log('Window loaded, starting initialization...');
      try {
        console.log('Attempting to initialize map...');
        initMap();
        console.log('Map initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
        // Continue even if map fails
      }
      
      try {
        console.log('Testing DOM elements...');
        const loginBtn = document.querySelector('button[onclick="showLogin()"]');
        const loginModal = document.getElementById('loginModal');
        console.log('Login button found:', !!loginBtn);
        console.log('Login modal found:', !!loginModal);
        
        if (!loginBtn) {
          console.error('Login button not found!');
        }
        if (!loginModal) {
          console.error('Login modal not found!');
        }
      } catch (error) {
        console.error('Error checking DOM elements:', error);
      }
    });

    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });

    // User Dashboard Functions
    function showUserTab(tabName) {
      // Remove active class from all tabs and contents
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Initialize map if map tab is selected
      if (tabName === 'map') {
        setTimeout(() => initUserMap(), 100);
      }
      
      // Initialize battery health if battery-health tab is selected
      if (tabName === 'battery-health') {
        setTimeout(() => {
          try {
            console.log('Initializing Battery Health System...');
            if (window.batteryHealthSystem) {
              console.log('Using existing battery health system');
              const content = window.batteryHealthSystem.renderDashboard();
              document.getElementById('batteryHealthContent').innerHTML = content;
            } else {
              console.log('Creating new battery health system');
              // Check if BatteryHealthSystem class exists
              if (typeof BatteryHealthSystem !== 'undefined') {
                window.batteryHealthSystem = new BatteryHealthSystem();
                const content = window.batteryHealthSystem.renderDashboard();
                document.getElementById('batteryHealthContent').innerHTML = content;
                console.log('Battery health system initialized successfully');
              } else {
                console.error('BatteryHealthSystem class not found');
                document.getElementById('batteryHealthContent').innerHTML = `
                  <div style="text-align: center; padding: 40px; color: var(--danger);">
                    <h3>‚ùå L·ªói t·∫£i Battery Health System</h3>
                    <p>Kh√¥ng th·ªÉ kh·ªüi t·∫°o h·ªá th·ªëng qu·∫£n l√Ω pin. Vui l√≤ng refresh trang.</p>
                    <button class="btn btn-primary" onclick="location.reload()">üîÑ Refresh Trang</button>
                  </div>
                `;
              }
            }
          } catch (error) {
            console.error('Error initializing battery health:', error);
            document.getElementById('batteryHealthContent').innerHTML = `
              <div style="text-align: center; padding: 40px; color: var(--danger);">
                <h3>‚ùå L·ªói: ${error.message}</h3>
                <p>Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt l·ªói.</p>
                <button class="btn btn-primary" onclick="location.reload()">üîÑ Refresh Trang</button>
              </div>
            `;
          }
        }, 100);
      }
    }

    // Global station data that can be updated
    let globalStationData = {
      station1: [
        { 
          id: 'A1', 
          name: 'Tr·ª• A1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'has-battery', battery: '95%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'charging', battery: '75%' },
            { id: 5, status: 'charging', battery: '100%' },
            { id: 6, status: 'has-battery', battery: '98%' },
            { id: 7, status: 'empty', battery: '0%' },
            { id: 8, status: 'charging', battery: '88%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '100%' }
          ]
        },
        { 
          id: 'A2', 
          name: 'Tr·ª• A2',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'empty', battery: '0%' },
            { id: 3, status: 'charging', battery: '92%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '85%' },
            { id: 6, status: 'has-battery', battery: '96%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '67%' }
          ]
        },
        { 
          id: 'B1', 
          name: 'Tr·ª• B1',
          slots: [
            { id: 1, status: 'charging', battery: '45%' },
            { id: 2, status: 'charging', battery: '100%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'charging', battery: '68%' },
            { id: 5, status: 'has-battery', battery: '100%' },
            { id: 6, status: 'empty', battery: '0%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'has-battery', battery: '94%' },
            { id: 9, status: 'charging', battery: '72%' },
            { id: 10, status: 'empty', battery: '0%' }
          ]
        }
      ],
      station2: [
        { 
          id: 'C1', 
          name: 'Tr·ª• C1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '88%' },
            { id: 3, status: 'has-battery', battery: '96%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '100%' },
            { id: 6, status: 'has-battery', battery: '100%' },
            { id: 7, status: 'empty', battery: '0%' },
            { id: 8, status: 'charging', battery: '54%' },
            { id: 9, status: 'has-battery', battery: '92%' },
            { id: 10, status: 'charging', battery: '100%' }
          ]
        },
        { 
          id: 'D1', 
          name: 'Tr·ª• D1',
          slots: [
            { id: 1, status: 'charging', battery: '100%' },
            { id: 2, status: 'charging', battery: '65%' },
            { id: 3, status: 'has-battery', battery: '100%' },
            { id: 4, status: 'charging', battery: '94%' },
            { id: 5, status: 'empty', battery: '0%' },
            { id: 6, status: 'has-battery', battery: '98%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '79%' }
          ]
        }
      ],
      station3: [
        { 
          id: 'E1', 
          name: 'Tr·ª• E1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '78%' },
            { id: 3, status: 'charging', battery: '100%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '56%' },
            { id: 6, status: 'has-battery', battery: '95%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '83%' }
          ]
        }
      ],
      station4: [
        { 
          id: 'F1', 
          name: 'Tr·ª• F1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '100%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'has-battery', battery: '97%' },
            { id: 5, status: 'charging', battery: '62%' },
            { id: 6, status: 'empty', battery: '0%' },
            { id: 7, status: 'has-battery', battery: '100%' },
            { id: 8, status: 'charging', battery: '100%' },
            { id: 9, status: 'empty', battery: '0%' },
            { id: 10, status: 'charging', battery: '91%' }
          ]
        }
      ]
    };

    function loadStationPosts() {
      const stationSelect = document.getElementById('station-select');
      const postsContainer = document.getElementById('posts-container');
      const postGrid = document.getElementById('post-grid');
      const noStation = document.getElementById('no-station');
      const selectedStation = stationSelect.value;
      
      if (selectedStation) {
        postGrid.style.display = 'block';
        noStation.style.display = 'none';
        
        // Use global data that can be updated
        const posts = globalStationData[selectedStation] || [];
        postsContainer.innerHTML = '';
        
        posts.forEach(post => {
          const readyBatteries = post.slots.filter(slot => 
            slot.status === 'has-battery' || 
            (slot.status === 'charging' && slot.battery === '100%')
          ).length;
          const emptySlots = post.slots.filter(slot => slot.status === 'empty').length;
          const isAvailable = readyBatteries > 0 && emptySlots > 0;
          
          const postElement = document.createElement('div');
          postElement.className = `post-item ${isAvailable ? '' : 'occupied'}`;
          postElement.onclick = () => isAvailable ? selectPost(post) : null;
          
          postElement.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">${post.name}</div>
            <div style="font-size: 12px; margin-bottom: 4px;">
              üîã ${readyBatteries} pin s·∫µn s√†ng
            </div>
            <div style="font-size: 11px; color: var(--muted);">
                ${emptySlots} slot tr·ªëng
            </div>
          `;
          
          if (!isAvailable) {
            postElement.style.cursor = 'not-allowed';
            postElement.onclick = null;
          }
          
          postsContainer.appendChild(postElement);
        });
      } else {
        postGrid.style.display = 'none';
        noStation.style.display = 'block';
        hideSelectedPostInfo();
      }
      
      updateSwapButton();
    }

    let selectedPost = null;
    let selectedPickupSlot = null;
    let selectedReturnSlot = null;
    
    function selectPost(post) {
      // Remove previous selection
      document.querySelectorAll('.post-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection to clicked post
      event.target.classList.add('selected');
      
      // Get updated post data from global data
      const stationSelect = document.getElementById('station-select');
      const selectedStationKey = stationSelect.value;
      
      if (globalStationData[selectedStationKey]) {
        const posts = globalStationData[selectedStationKey];
        const updatedPost = posts.find(p => p.id === post.id);
        selectedPost = updatedPost || post;
      } else {
        selectedPost = post;
      }
      
      selectedPickupSlot = null;
      selectedReturnSlot = null;
      
      showSelectedPostInfo(selectedPost);
      updateSwapButton();
    }
    
    function showSelectedPostInfo(post) {
      const selectedPostInfo = document.getElementById('selected-post-info');
      const postDetails = document.getElementById('post-details');
      
      postDetails.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${post.name}</strong><br>
            <span class="muted">  ƒê√£ ch·ªçn tr·ª• n√†y</span>
          </div>
          <div style="font-size: 24px;">‚ö°</div>
        </div>
      `;
      
      showSlotSelection(post);
      selectedPostInfo.style.display = 'block';
    }
    
    function showSlotSelection(post) {
      const availableSlots = document.getElementById('available-slots');
      const emptySlots = document.getElementById('empty-slots');
      
      // Clear previous selections
      availableSlots.innerHTML = '';
      emptySlots.innerHTML = '';
      
      post.slots.forEach(slot => {
        if (slot.status === 'has-battery') {
          const slotElement = document.createElement('div');
          // Only show green if battery is 100%, otherwise show as charging
          if (slot.battery === '100%') {
            slotElement.className = 'slot-item has-battery';
            slotElement.onclick = () => selectPickupSlot(slot);
          } else {
            slotElement.className = 'slot-item charging';
            slotElement.style.cursor = 'not-allowed';
            slotElement.style.opacity = '0.8';
          }
          slotElement.innerHTML = `
            <div>Slot ${slot.id}</div>
            <div style="font-size: 10px;">${slot.battery}</div>
            ${slot.battery !== '100%' ? '<div style="font-size: 9px; color: var(--warn);">Ch∆∞a ƒë·ªß</div>' : ''}
          `;
          availableSlots.appendChild(slotElement);
        } else if (slot.status === 'charging') {
          const slotElement = document.createElement('div');
          if (slot.battery === '100%') {
            // Charging complete - can be picked up, show as green like has-battery
            slotElement.className = 'slot-item has-battery';
            slotElement.onclick = () => selectPickupSlot(slot);
            slotElement.innerHTML = `
              <div>Slot ${slot.id}</div>
              <div style="font-size: 10px;">${slot.battery}</div>
              <div style="font-size: 9px; color: var(--ok);">S·∫µn s√†ng</div>
            `;
          } else {
            // Still charging - cannot be picked up
            slotElement.className = 'slot-item charging';
            slotElement.style.cursor = 'not-allowed';
            slotElement.style.opacity = '0.6';
            slotElement.innerHTML = `
              <div>Slot ${slot.id}</div>
              <div style="font-size: 10px;">‚ö°${slot.battery}</div>
              <div style="font-size: 9px; color: var(--warn);">ƒêang s·∫°c</div>
            `;
          }
          availableSlots.appendChild(slotElement);
        } else if (slot.status === 'empty') {
          const slotElement = document.createElement('div');
          slotElement.className = 'slot-item empty';
          slotElement.onclick = () => selectReturnSlot(slot);
          slotElement.innerHTML = `
            <div>Slot ${slot.id}</div>
            <div style="font-size: 10px;">Tr·ªëng</div>
          `;
          emptySlots.appendChild(slotElement);
        }
      });
    }
    
    function selectPickupSlot(slot) {
      // Only allow selection if battery is 100%
      if (slot.battery !== '100%') {
        showToast(`Slot ${slot.id} c√≥ pin ${slot.battery}, ch·ªâ c√≥ th·ªÉ l·∫•y pin 100%`, 'warning');
        return;
      }
      
      // Remove previous selections
      document.querySelectorAll('#available-slots .slot-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection
      event.target.classList.add('selected');
      selectedPickupSlot = slot;
      updateSwapButton();
    }
    
    function selectReturnSlot(slot) {
      // Remove previous selections
      document.querySelectorAll('#empty-slots .slot-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection
      event.target.classList.add('selected');
      selectedReturnSlot = slot;
      updateSwapButton();
    }
    
    function hideSelectedPostInfo() {
      document.getElementById('selected-post-info').style.display = 'none';
      selectedPost = null;
      selectedPickupSlot = null;
      selectedReturnSlot = null;
    }
    
    function updateSwapButton() {
      const swapBtn = document.getElementById('swap-btn');
      const stationSelect = document.getElementById('station-select');
      
      const canSwap = stationSelect.value && selectedPost && selectedPickupSlot && selectedReturnSlot;
      
      swapBtn.disabled = !canSwap;
      
      if (canSwap) {
        swapBtn.textContent = `üöÄ L·∫•y pin t·ª´ Slot ${selectedPickupSlot.id} ‚Üí Tr·∫£ v√†o Slot ${selectedReturnSlot.id}`;
        swapBtn.style.opacity = '1';
      } else if (selectedPost && (!selectedPickupSlot || !selectedReturnSlot)) {
        swapBtn.textContent = 'üîã Ch·ªçn slot l·∫•y pin v√† slot tr·∫£ pin';
        swapBtn.style.opacity = '0.6';
      } else {
        swapBtn.textContent = 'üöÄ Ch·ªçn tr·∫°m v√† tr·ª• ƒë·ªÉ ti·∫øp t·ª•c';
        swapBtn.style.opacity = '0.6';
      }
    }
    
    function startBatterySwap() {
      if (!selectedPost || !selectedPickupSlot || !selectedReturnSlot) {
        showToast('Vui l√≤ng ch·ªçn tr·ª• v√† slot ƒë·ªïi pin', 'warning');
        return;
      }
      
      const stationName = document.getElementById('station-select').selectedOptions[0].text;
      
      // Show progress
      document.getElementById('swap-status').style.display = 'none';
      document.getElementById('swap-progress').style.display = 'block';
      
      // Simulate IoT process
      simulateSwapProcess(stationName);
    }
    
    function simulateSwapProcess(stationName) {
      const progressText = document.getElementById('progress-text');
      const steps = [
        { text: `ƒêang m·ªü Slot ${selectedPickupSlot.id}...`, duration: 1500 },
        { text: 'Vui l√≤ng l·∫•y pin m·ªõi ra kh·ªèi slot', duration: 2000 },
        { text: `ƒêang m·ªü Slot ${selectedReturnSlot.id}...`, duration: 1500 },
        { text: 'Vui l√≤ng ƒë·∫∑t pin c≈© v√†o slot tr·ªëng', duration: 2000 },
        { text: 'ƒêang kh√≥a t·∫•t c·∫£ slot...', duration: 1000 },
        { text: 'Ho√†n th√†nh ƒë·ªïi pin!', duration: 1000 }
      ];
      
      let currentStep = 0;
      
      function nextStep() {
        if (currentStep < steps.length) {
          const step = steps[currentStep];
          progressText.innerHTML = `
            <h4>${step.text}</h4>
            <p class="muted">B∆∞·ªõc ${currentStep + 1}/${steps.length}</p>
          `;
          
          setTimeout(() => {
            currentStep++;
            if (currentStep < steps.length) {
              nextStep();
            } else {
              completeSwap(stationName);
            }
          }, step.duration);
        }
      }
      
      nextStep();
    }
    
    function completeSwap(stationName) {
      // Hide progress
      document.getElementById('swap-progress').style.display = 'none';
      
      // Show success
      document.getElementById('swap-status').innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px; color: var(--ok);">‚úÖ</div>
        <h4 style="color: var(--ok);">ƒê·ªïi pin th√†nh c√¥ng!</h4>
        <p class="muted">L·∫•y pin t·ª´ ${selectedPost.name} - Slot ${selectedPickupSlot.id}</p>
        <p class="muted">Tr·∫£ pin v√†o ${selectedPost.name} - Slot ${selectedReturnSlot.id}</p>
        <p class="muted">Pin c≈© s·∫Ω ƒë∆∞·ª£c s·∫°c t·ª± ƒë·ªông</p>
        <button class="btn btn-primary" onclick="finishSwap()" style="margin-top: 12px;">Ho√†n t·∫•t ƒë·ªïi pin</button>
      `;
      document.getElementById('swap-status').style.display = 'block';
      
      showToast('üéâ ƒê·ªïi pin th√†nh c√¥ng! Pin c≈© ƒëang ƒë∆∞·ª£c s·∫°c t·ª± ƒë·ªông.', 'success');
    }
    
    function finishSwap() {
      // Update slot states after swap
      updateSlotStates();
      
      // Add new swap record to history
      addSwapHistory();
      
      // Reset form
      document.getElementById('station-select').value = '';
      hideSelectedPostInfo();
      document.getElementById('post-grid').style.display = 'none';
      document.getElementById('no-station').style.display = 'block';
      selectedPost = null;
      selectedPickupSlot = null;
      selectedReturnSlot = null;
      
      // Reset status
      document.getElementById('swap-status').innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">‚ö°</div>
        <h4>S·∫µn s√†ng ƒë·ªïi pin</h4>
        <p class="muted">Ch·ªçn tr·∫°m v√† tr·ª• ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
      `;
      
      updateSwapButton();
      showToast('C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!', 'success');
    }

    function updateSlotStates() {
      if (!selectedPost || !selectedPickupSlot || !selectedReturnSlot) return;
      
      // Find the station and post in our global data
      const stationSelect = document.getElementById('station-select');
      const selectedStationKey = stationSelect.value;
      
      // Find current post and update slot states
      if (globalStationData[selectedStationKey]) {
        const posts = globalStationData[selectedStationKey];
        const currentPost = posts.find(post => post.id === selectedPost.id);
        
        if (currentPost) {
          // Update pickup slot to empty
          const pickupSlot = currentPost.slots.find(slot => slot.id === selectedPickupSlot.id);
          if (pickupSlot) {
            pickupSlot.status = 'empty';
            pickupSlot.battery = '0%';
          }
          
          // Update return slot to charging with old battery level
          const returnSlot = currentPost.slots.find(slot => slot.id === selectedReturnSlot.id);
          if (returnSlot) {
            returnSlot.status = 'charging';
            returnSlot.battery = '25%'; // Assume old battery is low
          }
          
          showToast(`C·∫≠p nh·∫≠t: Slot ${selectedPickupSlot.id} ‚Üí tr·ªëng, Slot ${selectedReturnSlot.id} ‚Üí ƒëang s·∫°c 25%`, 'success');
        }
      }
    }

    function addSwapHistory() {
      const now = new Date();
      const timeString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      const stationName = document.getElementById('station-select').selectedOptions[0].text.split('(')[0].trim();
      const stationShort = stationName.replace('Tr·∫°m ', '').substring(0, 8);
      
      // Add to battery swap history table
      const historyTable = document.querySelector('#battery-swap-tab table tbody');
      if (historyTable) {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${timeString}</td>
          <td>${stationShort}/${selectedPost.name.replace('Tr·ª• ', '')}</td>
          <td>0ƒë (Premium)</td>
          <td><span class="status success">Th√†nh c√¥ng</span></td>
        `;
        historyTable.insertBefore(newRow, historyTable.firstChild);
        
        // Remove last row if more than 5 records
        if (historyTable.children.length > 5) {
          historyTable.removeChild(historyTable.lastChild);
        }
      }
      
      // Add to payment history if in that tab
      const paymentHistoryTable = document.getElementById('payment-history-table');
      if (paymentHistoryTable) {
        const paymentId = '#PAY' + String(Date.now()).slice(-3);
        const newPaymentRow = document.createElement('tr');
        newPaymentRow.innerHTML = `
          <td>${paymentId}</td>
          <td>${timeString}</td>
          <td>ƒê·ªïi pin</td>
          <td>0ƒë</td>
          <td>G√≥i Premium</td>
          <td><span class="status success">Th√†nh c√¥ng</span></td>
          <td><button class="action-btn" onclick="viewPaymentDetail('${paymentId}')">Chi ti·∫øt</button></td>
        `;
        paymentHistoryTable.insertBefore(newPaymentRow, paymentHistoryTable.firstChild);
        
        // Remove last row if more than 8 records
        if (paymentHistoryTable.children.length > 8) {
          paymentHistoryTable.removeChild(paymentHistoryTable.lastChild);
        }
      }
      
      // Add to overview recent activity
      const overviewTable = document.querySelector('#overview-tab table tbody');
      if (overviewTable) {
        const newActivityRow = document.createElement('tr');
        newActivityRow.innerHTML = `
          <td>${timeString}</td>
          <td>ƒê·ªïi pin t·∫°i ${stationShort}</td>
          <td><span class="status success">Ho√†n th√†nh</span></td>
        `;
        overviewTable.insertBefore(newActivityRow, overviewTable.firstChild);
        
        // Remove last row if more than 3 records
        if (overviewTable.children.length > 3) {
          overviewTable.removeChild(overviewTable.lastChild);
        }
      }
      
      // Update stats - decrease remaining swaps for premium plan
      updatePremiumPlanStats();
    }
    
    function updatePremiumPlanStats() {
      // Update plan status in battery swap tab
      const planStatus = document.getElementById('plan-status');
      if (planStatus) {
        const currentRemaining = 4; // This would come from user data in real app
        const newRemaining = Math.max(0, currentRemaining - 1);
        planStatus.innerHTML = `
          <div style="background: rgba(25,195,125,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(25,195,125,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span>üì¶ G√≥i Premium:</span><br>
                <span class="muted">C√≤n l·∫°i ${newRemaining}/8 l∆∞·ª£t th√°ng n√†y</span>
              </div>
              <span style="font-size: 20px; font-weight: 700; color: var(--ok);">MI·ªÑN PH√ç</span>
            </div>
          </div>
        `;
      }
      
      // Update overview stats
      const swapCountStat = document.querySelector('#overview-tab .stat-card .stat-value');
      if (swapCountStat && swapCountStat.textContent === '12') {
        swapCountStat.textContent = '13';
      }
    }

    function filterPaymentHistory() {
      // Demo filter function - in real app would filter the table
      showToast('ƒê√£ √°p d·ª•ng b·ªô l·ªçc', 'success');
    }

    function viewPaymentDetail(paymentId) {
      showToast(`Xem chi ti·∫øt giao d·ªãch ${paymentId}`, 'success');
    }

    function selectPlan(planType) {
      if (planType === 'basic') {
        showToast('B·∫°n ƒë√£ chuy·ªÉn sang thanh to√°n theo l∆∞·ª£t', 'success');
      }
    }

    function extendPlan(planType) {
      showToast('ƒê√£ gia h·∫°n g√≥i Premium th√™m 1 th√°ng', 'success');
    }

    function upgradePlan(planType) {
      showToast('Y√™u c·∫ßu n√¢ng c·∫•p l√™n Enterprise ƒë√£ ƒë∆∞·ª£c g·ª≠i', 'success');
    }

    function updateTopUpAmount() {
      const select = document.getElementById('top-up-amount');
      const customInput = document.getElementById('custom-amount');
      
      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }
    }

    function processTopUp() {
      const amount = document.getElementById('top-up-amount').value;
      const customAmount = document.getElementById('custom-amount').value;
      const finalAmount = amount === 'custom' ? customAmount : amount;
      
      if (finalAmount) {
        showToast(`ƒêang x·ª≠ l√Ω n·∫°p ${parseInt(finalAmount).toLocaleString()}ƒë...`, 'success');
        // In real app, would redirect to payment gateway
      } else {
        showToast('Vui l√≤ng ch·ªçn s·ªë ti·ªÅn c·∫ßn n·∫°p', 'warning');
      }
    }

    let userMap;
    function initUserMap() {
      if (userMap) return; // Don't reinitialize if already exists
      
      userMap = L.map('user-map').setView([16.0678, 108.2208], 6);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(userMap);

      stations.forEach((station, index) => {
        const color = station.status === 'active' ? '#19c37d' : '#ff5573';
        const icon = L.divIcon({
          html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${station.pins}</div>`,
          iconSize: [24, 24],
          className: 'custom-div-icon'
        });

        const marker = L.marker([station.lat, station.lng], { icon })
          .addTo(userMap)
          .bindPopup(`
            <div style="min-width: 200px;">
              <strong>${station.name}</strong><br>
              üìç ${station.area}<br>
              üîã ${station.pins} pin s·∫µn s√†ng<br>
              üìä Tr·∫°ng th√°i: ${station.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'B·∫£o tr√¨'}<br>
              <button onclick="selectStationForBooking('${station.name}')" style="margin-top: 8px; padding: 4px 8px; background: #4f8cff; border: none; border-radius: 4px; color: white; cursor: pointer;">ƒê·ªïi pin t·∫°i ƒë√¢y</button>
            </div>
          `);

        marker.on('click', () => {
          updateSelectedStationInfo(station);
        });
      });
    }

    function updateSelectedStationInfo(station) {
      const infoDiv = document.getElementById('selected-station-info');
      infoDiv.innerHTML = `
        <h4>${station.name}</h4>
        <p><strong>üìç ƒê·ªãa ch·ªâ:</strong> ${station.area}</p>
        <p><strong>üîã Pin s·∫µn s√†ng:</strong> ${station.pins}</p>
        <p><strong>üìä Tr·∫°ng th√°i:</strong> <span class="status ${station.status === 'active' ? 'success' : 'danger'}">${station.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'B·∫£o tr√¨'}</span></p>
        <div style="margin-top: 12px;">
          <button class="btn btn-primary" onclick="selectStationForBooking('${station.name}')" style="width: 100%;">ƒê·ªïi pin t·∫°i ƒë√¢y</button>
        </div>
      `;
    }

    function selectStationForBooking(stationName) {
      // Switch to battery-swap tab and pre-select station
      showUserTab('battery-swap');
      
      // Find and select the station in dropdown
      const stationSelect = document.getElementById('station-select');
      for (let option of stationSelect.options) {
        if (option.text.includes(stationName)) {
          stationSelect.value = option.value;
          loadStationPosts();
          break;
        }
      }
      
      showToast(`ƒê√£ ch·ªçn ${stationName} ƒë·ªÉ ƒë·ªïi pin`, 'success');
    }

    function findMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          if (userMap) {
            userMap.setView([lat, lng], 12);
            
            // Add user location marker
            L.marker([lat, lng], {
              icon: L.divIcon({
                html: '<div style="background: #4f8cff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [16, 16],
                className: 'user-location-marker'
              })
            }).addTo(userMap).bindPopup('V·ªã tr√≠ c·ªßa b·∫°n');
          }
          
          showToast('ƒê√£ ƒë·ªãnh v·ªã th√†nh c√¥ng', 'success');
        }, (error) => {
          showToast('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠', 'warning');
        });
      } else {
        showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã', 'warning');
      }
    }

    function filterActiveStations() {
      showToast('Hi·ªÉn th·ªã ch·ªâ c√°c tr·∫°m ƒëang ho·∫°t ƒë·ªông', 'success');
      // In real app, would filter map markers
    }

    function showAllStations() {
      showToast('Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c tr·∫°m', 'success');
      // In real app, would show all markers
    }

    function searchStations() {
      const searchTerm = document.getElementById('station-search').value.toLowerCase();
      showToast(`T√¨m ki·∫øm: "${searchTerm}"`, 'success');
      // In real app, would filter stations list and map
    }

    function filterByDistance() {
      showToast('ƒê√£ √°p d·ª•ng b·ªô l·ªçc kho·∫£ng c√°ch', 'success');
      // In real app, would filter by distance from user location
    }

    function focusStation(stationId) {
      const station = stations.find(s => s.name.includes('B√πi Th·ªã Xu√¢n') && stationId === 'station1') ||
                    stations.find(s => s.name.includes('C·∫ßu Gi·∫•y') && stationId === 'station2');
      
      if (station && userMap) {
        userMap.setView([station.lat, station.lng], 15);
        updateSelectedStationInfo(station);
        showToast(`ƒê√£ focus v√†o ${station.name}`, 'success');
      }
    }

    // Payment functions
    let currentPlanOrder = null;

    function purchasePlan(planType, planName, price, description) {
      currentPlanOrder = {
        type: planType,
        name: planName,
        price: price,
        description: description,
        orderDate: new Date().toISOString(),
        orderId: 'SWP' + Date.now()
      };

      document.getElementById('selected-plan-info').textContent = `${planName} - ${price.toLocaleString()}ƒë`;
      document.getElementById('plan-description').textContent = description;
      document.getElementById('payment-modal').style.display = 'block';
    }

    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
      
      const step1 = document.getElementById('payment-step-1');
      const step2 = document.getElementById('payment-step-2');
      const step3 = document.getElementById('payment-step-3');
      const paymentBtn = document.getElementById('payment-btn');
      
      if (step1) step1.style.display = 'block';
      if (step2) step2.style.display = 'none';
      if (step3) step3.style.display = 'none';
      if (paymentBtn) paymentBtn.style.display = 'block';
      
      // Reset form
      const cardNumber = document.getElementById('card-number');
      const cardExpiry = document.getElementById('card-expiry');
      const cardCvv = document.getElementById('card-cvv');
      const cardHolder = document.getElementById('card-holder');
      const agreeTerms = document.getElementById('agree-terms');
      
      if (cardNumber) cardNumber.value = '';
      if (cardExpiry) cardExpiry.value = '';
      if (cardCvv) cardCvv.value = '';
      if (cardHolder) cardHolder.value = '';
      if (agreeTerms) agreeTerms.checked = false;
    }

    function processPayment() {
      // Validate form
      const cardNumber = document.getElementById('card-number').value;
      const cardExpiry = document.getElementById('card-expiry').value;
      const cardCvv = document.getElementById('card-cvv').value;
      const cardHolder = document.getElementById('card-holder').value;
      const agreeTerms = document.getElementById('agree-terms').checked;

      if (!cardNumber || !cardExpiry || !cardCvv || !cardHolder || !agreeTerms) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ƒë·ªìng √Ω ƒëi·ªÅu kho·∫£n', 'error');
        return;
      }

      // Show processing step
      document.getElementById('payment-step-1').style.display = 'none';
      document.getElementById('payment-step-2').style.display = 'block';
      document.getElementById('payment-btn').style.display = 'none';

      // Simulate payment processing
      setTimeout(() => {
        // Payment successful
        document.getElementById('payment-step-2').style.display = 'none';
        document.getElementById('payment-step-3').style.display = 'block';

        // Update user plan
        if (auth.currentUser) {
          auth.currentUser.plan = currentPlanOrder.type;
          auth.currentUser.planExpiry = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
          localStorage.setItem('userData', JSON.stringify(auth.currentUser));
        }

        // Add to payment history
        addPaymentRecord({
          date: new Date().toLocaleDateString('vi-VN'),
          description: `Mua ${currentPlanOrder.name}`,
          amount: `${currentPlanOrder.price.toLocaleString()}ƒë`,
          status: 'Th√†nh c√¥ng',
          orderId: currentPlanOrder.orderId
        });

        showToast('Thanh to√°n th√†nh c√¥ng! G√≥i d·ªãch v·ª• ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t', 'success');
        
        // Update dashboard
        setTimeout(() => {
          if (document.getElementById('userDashboard').classList.contains('active')) {
            location.reload(); // Refresh to update plan info
          }
        }, 2000);
      }, 3000);
    }

    function showContract() {
      if (!currentPlanOrder) {
        showToast('Kh√¥ng c√≥ th√¥ng tin ƒë∆°n h√†ng', 'error');
        return;
      }

      const user = auth.currentUser;
      const contractDate = new Date().toLocaleDateString('vi-VN');
      const contractId = 'HD' + Date.now();
      
      const contractHTML = `
        <div class="contract-document">
          <div class="contract-header">
            <h2 style="text-align: center; margin-bottom: 10px;">H·ª¢P ƒê·ªíNG D·ªäCH V·ª§ ƒê·ªîI PIN ƒêI·ªÜN T·ª¨</h2>
            <div style="text-align: center; font-size: 14px; color: #666; margin-bottom: 30px;">
              S·ªë h·ª£p ƒë·ªìng: ${contractId} | Ng√†y: ${contractDate}
            </div>
          </div>

          <div class="contract-body">
            <div class="contract-section">
              <h3>B√äN CUNG C·∫§P D·ªäCH V·ª§ (B√™n A)</h3>
              <p><strong>C√¥ng ty TNHH SWP201 Battery Swap</strong></p>
              <p>ƒê·ªãa ch·ªâ: L√¥ E2a-7, ƒê∆∞·ªùng D1, ƒê. D1, Long Th·∫°nh M·ªπ, Th√†nh Ph·ªë Th·ªß ƒê·ª©c, H·ªì Ch√≠ Minh</p>
              <p>ƒêi·ªán tho·∫°i: 1900-SWP201 | Email: support@swp201.vn</p>
              <p>M√£ s·ªë thu·∫ø: 0123456789</p>
            </div>

            <div class="contract-section">
              <h3>B√äN S·ª¨ D·ª§NG D·ªäCH V·ª§ (B√™n B)</h3>
              <p><strong>${user.name}</strong></p>
              <p>Email: ${user.username}</p>
              <p>S·ªë ƒëi·ªán tho·∫°i: ${user.phone || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
              <p>ƒê·ªãa ch·ªâ: ${user.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
            </div>

            <div class="contract-section">
              <h3>TH√îNG TIN G√ìI D·ªäCH V·ª§</h3>
              <table class="contract-table">
                <tr>
                  <td><strong>T√™n g√≥i:</strong></td>
                  <td>${currentPlanOrder.name}</td>
                </tr>
                <tr>
                  <td><strong>Gi√° tr·ªã:</strong></td>
                  <td>${currentPlanOrder.price.toLocaleString()}ƒë</td>
                </tr>
                <tr>
                  <td><strong>Th·ªùi h·∫°n:</strong></td>
                  <td>30 ng√†y k·ªÉ t·ª´ ng√†y k√≠ch ho·∫°t</td>
                </tr>
                <tr>
                  <td><strong>Ng√†y ƒëƒÉng k√Ω:</strong></td>
                  <td>${contractDate}</td>
                </tr>
                <tr>
                  <td><strong>M√£ ƒë∆°n h√†ng:</strong></td>
                  <td>${currentPlanOrder.orderId}</td>
                </tr>
              </table>
            </div>

            <div class="contract-section">
              <h3>ƒêI·ªÄU KHO·∫¢N D·ªäCH V·ª§</h3>
              <ol>
                <li><strong>Quy·ªÅn v√† nghƒ©a v·ª• c·ªßa B√™n A:</strong>
                  <ul>
                    <li>Cung c·∫•p d·ªãch v·ª• ƒë·ªïi pin theo ƒë√∫ng g√≥i ƒë√£ ƒëƒÉng k√Ω</li>
                    <li>ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng pin v√† an to√†n trong qu√° tr√¨nh s·ª≠ d·ª•ng</li>
                    <li>H·ªó tr·ª£ k·ªπ thu·∫≠t 24/7 cho g√≥i Premium v√† Enterprise</li>
                    <li>Th√¥ng b√°o tr∆∞·ªõc 7 ng√†y khi c√≥ thay ƒë·ªïi ch√≠nh s√°ch</li>
                  </ul>
                </li>
                <li><strong>Quy·ªÅn v√† nghƒ©a v·ª• c·ªßa B√™n B:</strong>
                  <ul>
                    <li>Thanh to√°n ƒë√∫ng h·∫°n theo g√≥i ƒë√£ ƒëƒÉng k√Ω</li>
                    <li>S·ª≠ d·ª•ng d·ªãch v·ª• ƒë√∫ng m·ª•c ƒë√≠ch v√† tu√¢n th·ªß quy ƒë·ªãnh</li>
                    <li>B·∫£o qu·∫£n thi·∫øt b·ªã v√† pin trong qu√° tr√¨nh s·ª≠ d·ª•ng</li>
                    <li>Th√¥ng b√°o k·ªãp th·ªùi khi c√≥ s·ª± c·ªë ho·∫∑c h·ªèng h√≥c</li>
                  </ul>
                </li>
                <li><strong>Ch√≠nh s√°ch ho√†n ti·ªÅn:</strong>
                  <ul>
                    <li>Ho√†n 100% trong 7 ng√†y ƒë·∫ßu n·∫øu ch∆∞a s·ª≠ d·ª•ng</li>
                    <li>Ho√†n 50% n·∫øu h·ªßy trong 15 ng√†y ƒë·∫ßu</li>
                    <li>Kh√¥ng ho√†n ti·ªÅn sau 15 ng√†y s·ª≠ d·ª•ng</li>
                  </ul>
                </li>
              </ol>
            </div>

            <div class="contract-section">
              <h3>CH·ªÆ K√ù ƒêI·ªÜN T·ª¨</h3>
              <div class="signature-section">
                <div class="signature-block">
                  <p><strong>B√™n A: SWP201 Company</strong></p>
                  <div class="digital-signature">
                    <div class="signature-stamp">
                      ƒê√É K√ù ƒêI·ªÜN T·ª¨<br>
                      <small>CEO Tr·∫ßn VƒÉn An</small><br>
                      <small>${contractDate}</small>
                    </div>
                  </div>
                </div>
                <div class="signature-block">
                  <p><strong>B√™n B: ${user.name}</strong></p>
                  <div class="digital-signature">
                    <div class="signature-stamp">
                      ƒê√É K√ù ƒêI·ªÜN T·ª¨<br>
                      <small>${user.username}</small><br>
                      <small>${contractDate}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="contract-footer">
              <p style="text-align: center; font-style: italic; color: #666;">
                H·ª£p ƒë·ªìng n√†y ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông v√† c√≥ gi√° tr·ªã ph√°p l√Ω theo Lu·∫≠t Giao d·ªãch ƒëi·ªán t·ª≠ Vi·ªát Nam
              </p>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contract-content').innerHTML = contractHTML;
      document.getElementById('contract-modal').style.display = 'block';
    }

    function closeContractModal() {
      const modal = document.getElementById('contract-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
    }

    function downloadContract() {
      showToast('T√≠nh nƒÉng t·∫£i xu·ªëng PDF s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau', 'info');
    }

    // Format card number input
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('card-number');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
          let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
          e.target.value = formattedValue;
        });
      }

      const cardExpiryInput = document.getElementById('card-expiry');
      if (cardExpiryInput) {
        cardExpiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }

      // Battery Health Management System
      class BatteryHealthSystem {
        constructor() {
          this.userBatteries = this.loadUserBatteries();
          this.healthHistory = this.loadHealthHistory();
          this.currentVehicle = null;
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.generateSampleData();
        }

        generateSampleData() {
          if (Object.keys(this.userBatteries).length === 0) {
            const sampleVehicles = [
              {
                id: 'BIKE001',
                name: 'VinFast Klara A2',
                type: 'scooter',
                batteryId: 'BAT001',
                batteryCapacity: 2.5, // kWh
                currentCharge: 85,
                health: 94,
                cycleCount: 156,
                manufactureDate: '2024-02-15',
                lastChecked: new Date().toISOString(),
                icon: 'üõµ'
              },
              {
                id: 'BIKE002', 
                name: 'VinFast Ludo',
                type: 'scooter',
                batteryId: 'BAT002',
                batteryCapacity: 1.8, // kWh
                currentCharge: 62,
                health: 89,
                cycleCount: 203,
                manufactureDate: '2023-11-08',
                lastChecked: new Date().toISOString(),
                icon: 'üõ¥'
              },
              {
                id: 'BIKE003',
                name: 'Honda PCX Electric',
                type: 'scooter',
                batteryId: 'BAT003',
                batteryCapacity: 1.3, // kWh
                currentCharge: 78,
                health: 91,
                cycleCount: 124,
                manufactureDate: '2024-05-20',
                lastChecked: new Date().toISOString(),
                icon: 'üèçÔ∏è'
              }
            ];

            sampleVehicles.forEach(vehicle => {
              this.userBatteries[vehicle.id] = vehicle;
              this.generateHealthHistory(vehicle.id);
            });

            this.saveUserBatteries();
            this.saveHealthHistory();
          }
        }

        generateHealthHistory(vehicleId) {
          const vehicle = this.userBatteries[vehicleId];
          if (!vehicle) return;

          const history = [];
          const startDate = new Date(vehicle.manufactureDate);
          const currentDate = new Date();
          const daysBetween = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));

          for (let i = 0; i <= daysBetween; i += 7) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            
            const ageMonths = i / 30;
            const baseHealth = 100;
            const degradationRate = 0.5;
            const randomVariation = (Math.random() - 0.5) * 2;
            
            const health = Math.max(
              baseHealth - (ageMonths * degradationRate) + randomVariation,
              vehicle.health - 5
            );

            history.push({
              date: date.toISOString().split('T')[0],
              health: Math.round(health * 10) / 10,
              chargeLevel: Math.floor(Math.random() * 100),
              temperature: Math.floor(Math.random() * 20) + 20,
              cycleCount: Math.floor((i / 7) * 2)
            });
          }

          this.healthHistory[vehicleId] = history;
        }

        loadUserBatteries() {
          const saved = localStorage.getItem('userBatteries');
          return saved ? JSON.parse(saved) : {};
        }

        loadHealthHistory() {
          const saved = localStorage.getItem('batteryHealthHistory');
          return saved ? JSON.parse(saved) : {};
        }

        saveUserBatteries() {
          localStorage.setItem('userBatteries', JSON.stringify(this.userBatteries));
        }

        saveHealthHistory() {
          localStorage.setItem('batteryHealthHistory', JSON.stringify(this.healthHistory));
        }

        setupEventListeners() {
          document.addEventListener('click', (e) => {
            if (e.target.matches('.select-vehicle-btn')) {
              const vehicleId = e.target.dataset.vehicleId;
              this.selectVehicle(vehicleId);
            }
            
            if (e.target.matches('.refresh-data-btn')) {
              this.refreshBatteryData();
            }

            if (e.target.matches('.export-report-btn')) {
              this.exportHealthReport();
            }
          });
        }

        renderBatteryHealthDashboard() {
          // Auto-select vehicle from current user
          const currentUser = auth?.currentUser;
          if (currentUser?.selectedVehicle && !this.currentVehicle) {
            const vehicleId = currentUser.selectedVehicle.id;
            this.currentVehicle = this.userBatteries[vehicleId] || currentUser.selectedVehicle;
          }

          return `
            <div class="battery-health-dashboard">
              <div class="dashboard-header">
                <h2>üîã Qu·∫£n L√Ω Pin Xe M√°y ƒêi·ªán</h2>
                <button class="btn btn-secondary refresh-data-btn">
                  üîÑ C·∫≠p Nh·∫≠t D·ªØ Li·ªáu
                </button>
              </div>

              ${this.currentVehicle ? this.renderDetailedView() : this.renderVehicleSelection()}
            </div>
          `;
        }

        renderVehicleSelection() {
          return `
            <div class="vehicle-selection">
              <h3>Ch·ªçn Xe M√°y ƒêi·ªán</h3>
              <div class="vehicle-grid">
                ${Object.values(this.userBatteries).map(vehicle => `
                  <div class="vehicle-card">
                    <div class="vehicle-info">
                      <h4>${vehicle.icon} ${vehicle.name}</h4>
                      <p>ID: ${vehicle.id}</p>
                      <div class="battery-preview">
                        <div class="charge-level">
                          <span class="charge-percent">${vehicle.currentCharge}%</span>
                          <div class="charge-bar">
                            <div class="charge-fill" style="width: ${vehicle.currentCharge}%"></div>
                          </div>
                        </div>
                        <div class="health-indicator">
                          <span class="health-percent ${this.getHealthClass(vehicle.health)}">
                            ${vehicle.health}% Health
                          </span>
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-primary select-vehicle-btn" data-vehicle-id="${vehicle.id}">
                      Chi Ti·∫øt
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        renderDetailedView() {
          const vehicle = this.currentVehicle;
          const history = this.healthHistory[vehicle.id] || [];
          const latestHistory = history.slice(-30);

          return `
            <div class="detailed-battery-view">
              <div class="vehicle-header">
                <h3>üìä ${vehicle.name} - Chi Ti·∫øt Pin</h3>
                <div class="last-updated">
                  C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date(vehicle.lastChecked).toLocaleString('vi-VN')}
                </div>
              </div>

              <div class="battery-metrics-grid">
                <div class="metric-card current-status">
                  <h4>üîã Tr·∫°ng Th√°i Hi·ªán T·∫°i</h4>
                  <div class="large-charge-display">
                    <div class="charge-circle">
                      <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                        <circle cx="50" cy="50" r="45" stroke="${this.getChargeColor(vehicle.currentCharge)}" 
                                stroke-width="8" fill="none" stroke-dasharray="283" 
                                stroke-dashoffset="${283 - (283 * vehicle.currentCharge / 100)}"
                                transform="rotate(-90 50 50)"/>
                      </svg>
                      <div class="charge-text">
                        <span class="charge-number">${vehicle.currentCharge}</span>
                        <span class="charge-unit">%</span>
                      </div>
                    </div>
                    <div class="range-estimate">
                      <strong>Qu√£ng ƒë∆∞·ªùng d·ª± ki·∫øn:</strong><br>
                      ${this.calculateRange(vehicle)}
                    </div>
                  </div>
                </div>

                <div class="metric-card health-status">
                  <h4>üíä ƒê·ªô Chai Pin</h4>
                  <div class="health-gauge">
                    <div class="health-bar">
                      <div class="health-fill ${this.getHealthClass(vehicle.health)}" 
                           style="width: ${vehicle.health}%"></div>
                    </div>
                    <div class="health-value">
                      <span class="health-number">${vehicle.health}%</span>
                      <span class="health-label">${this.getHealthStatus(vehicle.health)}</span>
                    </div>
                  </div>
                  <div class="health-details">
                    <div class="detail-item">
                      <span>Chu k·ª≥ s·∫°c:</span>
                      <strong>${vehicle.cycleCount} l·∫ßn</strong>
                    </div>
                    <div class="detail-item">
                      <span>Dung l∆∞·ª£ng g·ªëc:</span>
                      <strong>${vehicle.batteryCapacity} kWh</strong>
                    </div>
                    <div class="detail-item">
                      <span>Dung l∆∞·ª£ng hi·ªán t·∫°i:</span>
                      <strong>${(vehicle.batteryCapacity * vehicle.health / 100).toFixed(1)} kWh</strong>
                    </div>
                  </div>
                </div>

                <div class="metric-card battery-info">
                  <h4>üìã Th√¥ng Tin Pin</h4>
                  <div class="info-list">
                    <div class="info-item">
                      <span class="info-label">M√£ pin:</span>
                      <span class="info-value">${vehicle.batteryId}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Ng√†y s·∫£n xu·∫•t:</span>
                      <span class="info-value">${new Date(vehicle.manufactureDate).toLocaleDateString('vi-VN')}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Tu·ªïi pin:</span>
                      <span class="info-value">${this.calculateBatteryAge(vehicle.manufactureDate)}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Nhi·ªát ƒë·ªô pin:</span>
                      <span class="info-value">${latestHistory.length > 0 ? latestHistory[latestHistory.length - 1].temperature + '¬∞C' : 'N/A'}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="chart-section">
                <h4>üìà L·ªãch S·ª≠ ƒê·ªô Chai Pin</h4>
                <div class="chart-container">
                  ${this.renderHealthChart(latestHistory)}
                </div>
              </div>

              <div class="recommendations-section">
                <h4>üí° Khuy·∫øn Ngh·ªã</h4>
                <div class="recommendations-grid">
                  ${this.generateRecommendations(vehicle).map(rec => `
                    <div class="recommendation-card ${rec.type}">
                      <div class="rec-icon">${rec.icon}</div>
                      <div class="rec-content">
                        <h5>${rec.title}</h5>
                        <p>${rec.description}</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="export-section">
                <button class="btn btn-success export-report-btn">
                  üìä Xu·∫•t B√°o C√°o Pin
                </button>
              </div>
            </div>
          `;
        }

        getHealthClass(health) {
          if (health >= 90) return 'excellent';
          if (health >= 80) return 'good';
          if (health >= 70) return 'fair';
          return 'poor';
        }

        getHealthStatus(health) {
          if (health >= 90) return 'Tuy·ªát v·ªùi';
          if (health >= 80) return 'T·ªët';
          if (health >= 70) return 'Trung b√¨nh';
          return 'C·∫ßn ch√∫ √Ω';
        }

        getChargeColor(charge) {
          if (charge >= 70) return '#4CAF50';
          if (charge >= 30) return '#FF9800';
          return '#F44336';
        }

        calculateRange(vehicle) {
          const efficiency = 6;
          const usableCapacity = vehicle.batteryCapacity * vehicle.health / 100;
          const currentEnergy = usableCapacity * vehicle.currentCharge / 100;
          const range = Math.floor(currentEnergy * efficiency);
          return `${range} km`;
        }

        calculateBatteryAge(manufactureDate) {
          const now = new Date();
          const manufacture = new Date(manufactureDate);
          const diffTime = Math.abs(now - manufacture);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          const years = Math.floor(diffDays / 365);
          const months = Math.floor((diffDays % 365) / 30);
          return `${years} nƒÉm ${months} th√°ng`;
        }

        renderHealthChart(history) {
          if (history.length === 0) return '<p>Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠</p>';

          const maxHealth = Math.max(...history.map(h => h.health));
          const minHealth = Math.min(...history.map(h => h.health));
          const range = maxHealth - minHealth || 1;

          return `
            <div class="simple-chart">
              <div class="chart-y-axis">
                <span>${Math.ceil(maxHealth)}%</span>
                <span>${Math.ceil((maxHealth + minHealth) / 2)}%</span>
                <span>${Math.floor(minHealth)}%</span>
              </div>
              <div class="chart-area">
                <svg viewBox="0 0 400 200" class="chart-svg">
                  <polyline
                    fill="none"
                    stroke="#4CAF50"
                    stroke-width="2"
                    points="${history.map((point, index) => {
                      const x = (index / (history.length - 1)) * 380 + 10;
                      const y = 190 - ((point.health - minHealth) / range) * 180;
                      return `${x},${y}`;
                    }).join(' ')}"
                  />
                  ${history.map((point, index) => {
                    const x = (index / (history.length - 1)) * 380 + 10;
                    const y = 190 - ((point.health - minHealth) / range) * 180;
                    return `<circle cx="${x}" cy="${y}" r="3" fill="#4CAF50"/>`;
                  }).join('')}
                </svg>
              </div>
              <div class="chart-x-axis">
                <span>${history[0].date}</span>
                <span>${history[Math.floor(history.length / 2)].date}</span>
                <span>${history[history.length - 1].date}</span>
              </div>
            </div>
          `;
        }

        generateRecommendations(vehicle) {
          const recommendations = [];

          if (vehicle.currentCharge < 20) {
            recommendations.push({
              type: 'warning',
              icon: '‚ö†Ô∏è',
              title: 'Pin Th·∫•p',
              description: 'N√™n s·∫°c pin s·ªõm ƒë·ªÉ tr√°nh h·ªèng pin do x·∫£ qu√° s√¢u.'
            });
          } else if (vehicle.currentCharge > 90) {
            recommendations.push({
              type: 'info',
              icon: '‚ÑπÔ∏è',
              title: 'Pin ƒê·∫ßy',
              description: 'Kh√¥ng n√™n s·∫°c 100% th∆∞·ªùng xuy√™n ƒë·ªÉ b·∫£o v·ªá pin.'
            });
          }

          if (vehicle.health < 80) {
            recommendations.push({
              type: 'warning',
              icon: 'üîß',
              title: 'Ki·ªÉm Tra Pin',
              description: 'ƒê·ªô chai pin ƒë√£ cao, n√™n ki·ªÉm tra v√† b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥.'
            });
          }

          if (vehicle.cycleCount > 500) {
            recommendations.push({
              type: 'info',
              icon: 'üîÑ',
              title: 'Chu K·ª≥ S·∫°c Cao',
              description: 'Pin ƒë√£ qua nhi·ªÅu chu k·ª≥ s·∫°c, h√£y ch√∫ √Ω theo d√µi ƒë·ªô chai.'
            });
          }

          recommendations.push({
            type: 'success',
            icon: '‚úÖ',
            title: 'S·∫°c Th√¥ng Minh',
            description: 'Duy tr√¨ m·ª©c pin 20-80% ƒë·ªÉ t·ªëi ∆∞u tu·ªïi th·ªç pin.'
          });

          return recommendations;
        }

        selectVehicle(vehicleId) {
          this.currentVehicle = this.userBatteries[vehicleId];
          this.renderDashboard();
        }

        refreshBatteryData() {
          Object.values(this.userBatteries).forEach(vehicle => {
            vehicle.currentCharge = Math.max(0, Math.min(100, 
              vehicle.currentCharge + (Math.random() - 0.5) * 10
            ));
            vehicle.lastChecked = new Date().toISOString();
          });

          this.saveUserBatteries();
          this.renderDashboard();
          alert('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu pin m·ªõi nh·∫•t!');
        }

        exportHealthReport() {
          if (!this.currentVehicle) return;

          const report = this.generateHealthReport(this.currentVehicle);
          const blob = new Blob([report], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `battery-report-${this.currentVehicle.id}-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          
          URL.revokeObjectURL(url);
          alert('ƒê√£ xu·∫•t b√°o c√°o pin th√†nh c√¥ng!');
        }

        generateHealthReport(vehicle) {
          const history = this.healthHistory[vehicle.id] || [];
          
          return `
B√ÅO C√ÅO T√åNH TR·∫†NG PIN XE ƒêI·ªÜN
=====================================

Th√¥ng tin xe:
- T√™n xe: ${vehicle.name}
- M√£ xe: ${vehicle.id}
- M√£ pin: ${vehicle.batteryId}

T√¨nh tr·∫°ng hi·ªán t·∫°i:
- M·ª©c pin: ${vehicle.currentCharge}%
- ƒê·ªô chai pin: ${vehicle.health}%
- Chu k·ª≥ s·∫°c: ${vehicle.cycleCount} l·∫ßn
- Dung l∆∞·ª£ng pin: ${vehicle.batteryCapacity} kWh
- Dung l∆∞·ª£ng hi·ªán t·∫°i: ${(vehicle.batteryCapacity * vehicle.health / 100).toFixed(1)} kWh

Th√¥ng tin s·∫£n xu·∫•t:
- Ng√†y s·∫£n xu·∫•t: ${new Date(vehicle.manufactureDate).toLocaleDateString('vi-VN')}
- Tu·ªïi pin: ${this.calculateBatteryAge(vehicle.manufactureDate)}

L·ªãch s·ª≠ ƒë·ªô chai pin (30 ƒëi·ªÉm g·∫ßn nh·∫•t):
${history.slice(-30).map(h => 
  `${h.date}: ${h.health}% (${h.chargeLevel}% s·∫°c, ${h.temperature}¬∞C)`
).join('\n')}

Khuy·∫øn ngh·ªã:
${this.generateRecommendations(vehicle).map(r => 
  `- ${r.title}: ${r.description}`
).join('\n')}

B√°o c√°o t·∫°o l√∫c: ${new Date().toLocaleString('vi-VN')}
          `.trim();
        }

        renderDashboard() {
          const content = this.renderBatteryHealthDashboard();
          const batteryTab = document.querySelector('#batteryHealthContent');
          if (batteryTab) {
            batteryTab.innerHTML = content;
          }
          return content;
        }
      }

      // Debug: Log that BatteryHealthSystem class is defined
      console.log('BatteryHealthSystem class defined:', typeof BatteryHealthSystem);

      // Payment method selection
      document.addEventListener('change', function(e) {
        if (e.target.name === 'payment-method') {
          document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('active');
          });
          e.target.closest('.payment-method').classList.add('active');
          
          const creditCardForm = document.getElementById('credit-card-form');
          if (e.target.value === 'credit-card') {
            creditCardForm.style.display = 'block';
          } else {
            creditCardForm.style.display = 'none';
          }
        }
      });
      
      // Pre-initialize BatteryHealthSystem for faster loading
      console.log('Pre-initializing BatteryHealthSystem...');
      try {
        if (typeof BatteryHealthSystem !== 'undefined') {
          window.batteryHealthSystem = new BatteryHealthSystem();
          console.log('BatteryHealthSystem pre-initialized successfully');
        } else {
          console.warn('BatteryHealthSystem class not available yet');
        }
      } catch (error) {
        console.error('Error pre-initializing BatteryHealthSystem:', error);
      }

      // Clear all modals on page load to ensure UI is not blocked
      console.log('Clearing all modals on page load...');
      const modalIds = ['loginModal', 'registerModal', 'payment-modal', 'contract-modal'];
      modalIds.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
          modal.style.pointerEvents = 'none';
          console.log(`Cleared modal: ${modalId}`);
        }
      });

      // Also remove any dynamic modals that might exist
      const dynamicModals = document.querySelectorAll('.plan-selection-modal, .vehicle-selection-modal');
      dynamicModals.forEach(modal => {
        modal.remove();
        console.log('Removed dynamic modal');
      });

      // Ensure main content is visible and interactive
      const mainContent = document.querySelector('main');
      const header = document.querySelector('header');
      const footer = document.querySelector('footer');
      
      if (mainContent) {
        mainContent.style.display = 'block';
        mainContent.style.pointerEvents = 'auto';
      }
      if (header) {
        header.style.display = 'block';
        header.style.pointerEvents = 'auto';
      }
      if (footer) {
        footer.style.display = 'block';
        footer.style.pointerEvents = 'auto';
      }

      console.log('Page initialization complete - UI should be clickable now');
    });

    // Payment Sub-Tab Functions
    function showPaymentSubTab(tabName) {
      // Remove active class from all sub-tabs and contents
      document.querySelectorAll('.payment-sub-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.payment-sub-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      event.target.classList.add('active');
      document.getElementById(`${tabName}-subtab`).classList.add('active');
      
      // Update current plan info when showing payment tab
      if (tabName === 'payment' && auth.currentUser && auth.currentUser.selectedPlan) {
        updateCurrentPlanInfo();
      }
    }

    function updateCurrentPlanInfo() {
      const plan = auth.currentUser.selectedPlan;
      if (plan) {
        document.getElementById('current-plan-name').textContent = plan.name;
        document.getElementById('current-plan-price').textContent = plan.price;
        document.getElementById('current-plan-features').textContent = plan.features.join(' ‚Ä¢ ');
        document.getElementById('plan-payment-amount').textContent = plan.price.split('/')[0];
      }
    }

    function selectPaymentMethod(method) {
      // Remove selected class from all methods
      document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
      
      // Add selected class to clicked method
      event.currentTarget.classList.add('selected');
      
      // Update radio button
      document.querySelector(`input[name="payment-method"][value="${method}"]`).checked = true;
    }

    function processPayment() {
      const selectedMethod = document.querySelector('input[name="payment-method"]:checked');
      if (!selectedMethod) {
        showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n', 'error');
        return;
      }
      
      showToast('ƒêang x·ª≠ l√Ω thanh to√°n...', 'info');
      
      // Simulate payment processing
      setTimeout(() => {
        showToast('Thanh to√°n th√†nh c√¥ng!', 'success');
        
        // Add to payment history
        const newRow = `
          <tr>
            <td>#PAY00${Date.now().toString().slice(-3)}</td>
            <td>${new Date().toLocaleString('vi-VN')}</td>
            <td>Thanh to√°n g√≥i ${auth.currentUser.selectedPlan.name}</td>
            <td>${auth.currentUser.selectedPlan.price.split('/')[0]}</td>
            <td>${getMethodName(selectedMethod.value)}</td>
            <td><span class="status success">Th√†nh c√¥ng</span></td>
            <td><button class="action-btn" onclick="viewPaymentDetail('PAY00${Date.now().toString().slice(-3)}')">Chi ti·∫øt</button></td>
          </tr>
        `;
        document.getElementById('payment-history-table').insertAdjacentHTML('afterbegin', newRow);
      }, 2000);
    }

    function getMethodName(value) {
      const names = {
        'momo': 'V√≠ MoMo',
        'zalopay': 'ZaloPay', 
        'credit-card': 'Th·∫ª t√≠n d·ª•ng',
        'bank-transfer': 'Chuy·ªÉn kho·∫£n'
      };
      return names[value] || value;
    }

    function toggleAutoPay() {
      const checkbox = document.getElementById('autopay-enabled');
      const settings = document.getElementById('autopay-settings');
      const statusText = document.getElementById('autopay-status-text');
      
      if (checkbox.checked) {
        settings.style.display = 'block';
        statusText.textContent = 'B·∫≠t - Thanh to√°n t·ª± ƒë·ªông m·ªói th√°ng';
        showToast('ƒê√£ b·∫≠t thanh to√°n t·ª± ƒë·ªông', 'success');
      } else {
        settings.style.display = 'none';
        statusText.textContent = 'T·∫Øt - B·∫°n s·∫Ω thanh to√°n th·ªß c√¥ng m·ªói th√°ng';
        showToast('ƒê√£ t·∫Øt thanh to√°n t·ª± ƒë·ªông', 'info');
      }
    }

    function selectAutoPayMethod(method) {
      document.querySelector(`input[name="autopay-method"][value="${method}"]`).checked = true;
      
      // Visual feedback
      document.querySelectorAll('.autopay-method').forEach(el => el.style.background = 'rgba(255,255,255,.05)');
      event.currentTarget.style.background = 'rgba(79,140,255,.2)';
    }

    function updateAutoPaySettings() {
      const day = document.getElementById('autopay-day').value;
      showToast(`ƒê√£ c·∫≠p nh·∫≠t ng√†y thanh to√°n: ${day === 'end' ? 'Cu·ªëi th√°ng' : 'Ng√†y ' + day}`, 'info');
    }

    function saveAutoPaySettings() {
      const enabled = document.getElementById('autopay-enabled').checked;
      const day = document.getElementById('autopay-day').value;
      const method = document.querySelector('input[name="autopay-method"]:checked').value;
      
      // Save to localStorage
      const autoPaySettings = {
        enabled,
        day,
        method,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem('autoPaySettings', JSON.stringify(autoPaySettings));
      
      showToast('ƒê√£ l∆∞u c√†i ƒë·∫∑t thanh to√°n t·ª± ƒë·ªông!', 'success');
    }

    function testAutoPay() {
      showToast('ƒêang test thanh to√°n t·ª± ƒë·ªông...', 'info');
      
      setTimeout(() => {
        showToast('Test th√†nh c√¥ng! H·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.', 'success');
      }, 1500);
    }
  </script>
</body>
</html>
